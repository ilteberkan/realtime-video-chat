<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Opia - Görüntülü ve Sesli Sohbet</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
  <script>
    // Global bir değişkene io'yu atayalım ki Alpine.js kapsamından da erişebilelim
    window.ioInstance = null;
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof io !== 'undefined') {
        window.ioInstance = io;
        console.log('Socket.io global olarak tanımlandı');
      } else {
        console.error('Socket.io kütüphanesi yüklenemedi');
      }
    });
  </script>
  <!-- Socket.io CDN yerine mock socket kullanacağız -->
  <script>
    // Socket.io mock oluşturma - gerçek bağlantı kurulamadığında kullanılacak
    window.MockSocket = function() {
      console.log('Mock socket kullanılıyor');
      this.callbacks = {};
      
      this.on = function(event, callback) {
        if (!this.callbacks[event]) {
          this.callbacks[event] = [];
        }
        this.callbacks[event].push(callback);
        return this;
      };
      
      this.emit = function(event, data) {
        console.log(`Mock socket emit: ${event}`, data);
        return this;
      };
      
      this.mockTrigger = function(event, data) {
        if (this.callbacks[event]) {
          this.callbacks[event].forEach(callback => {
            callback(data);
          });
        }
      };
      
      return this;
    };
  </script>
  <!-- Favicon -->
  <link rel="icon" href="data:,">
  <style>
    :root {
      --color-bg: #ffffff;
      --color-text: #333333;
      --color-primary: #4f46e5;
      --color-secondary: #818cf8;
      --color-accent: #c7d2fe;
      --color-card: #f3f4f6;
    }
    
    .dark {
      --color-bg: #1f2937;
      --color-text: #f3f4f6;
      --color-primary: #6366f1;
      --color-secondary: #818cf8;
    }
    
    body {
      background-color: var(--color-bg);
      color: var(--color-text);
    }
    
    .logo {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--color-primary);
    }
    
    .logo svg {
      width: 40px;
      height: 40px;
      vertical-align: middle;
      margin-right: 8px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col" x-data="{
  darkMode: localStorage.getItem('darkMode') === 'true',
  user: null,
  inCall: false,
  searching: false,
  isMuted: false,
  isVideoOff: false,
  peerVideoOff: true,
  messages: [],
  messageText: '',
  toasts: [],
  isAdmin: false,
  waitingAnimation: false,
  // Medya akışları
  localStream: null,
  remoteStream: null,
  // WebRTC bağlantısı
  peerConnection: null,
  socket: null,
  currentRoomId: null,
  currentPeerId: null,
  // Zamanlayıcılar
  matchCheckInterval: null,
  toastTimeout: null,
  // Diğer değişkenler
  continuousSearch: false,
  // Bildirim göster
  showToast(message, type = 'info') {
    try {
      if (!this.toasts) {
        this.toasts = [];
      }
      
      const id = Date.now();
      this.toasts.push({ id, message, type });
      
      // 3 saniye sonra bildirimi kaldır
      setTimeout(() => {
        this.toasts = this.toasts.filter(toast => toast.id !== id);
      }, 3000);
    } catch (err) {
      console.error('Toast gösterme hatası:', err);
    }
  },
  // Giriş işlemi
  async login() {
    try {
      const supabaseClient = supabase.createClient(
        'https://unrfzoyltrqoyumrbhjo.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVucmZ6b3lsdHJxb3l1bXJiaGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5NDg5NDEsImV4cCI6MjA1NjUyNDk0MX0.4p18-Ohwnerg-qUpKr4f4TQWVWKBJtSdTdmDaoTJLDE'
      );
      
      // Tam URL kullan
      const currentUrl = window.location.origin;
      
      const { data, error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: currentUrl,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent'
          }
        }
      });
      
      if (error) throw error;
      console.log('Login başlatıldı:', data);
    } catch (err) {
      console.error('Login hatası:', err);
      this.showToast('Giriş işlemi sırasında bir hata oluştu', 'error');
    }
  },
  // Çıkış yap
  async logout() {
    try {
      await supabase.createClient(
        'https://unrfzoyltrqoyumrbhjo.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVucmZ6b3lsdHJxb3l1bXJiaGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5NDg5NDEsImV4cCI6MjA1NjUyNDk0MX0.4p18-Ohwnerg-qUpKr4f4TQWVWKBJtSdTdmDaoTJLDE'
      ).auth.signOut();
      this.user = null;
      this.isAdmin = false;
      
      // Aktif bağlantıları temizle
      if (this.inCall) {
        await this.endCall();
      }
      
      if (this.searching) {
        await this.cancelSearch();
      }
      
      this.showToast('Başarıyla çıkış yapıldı', 'success');
      
      // Sayfayı yenile
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } catch (err) {
      console.error('Çıkış hatası:', err);
      this.showToast('Çıkış yapılırken bir hata oluştu', 'error');
    }
  },
  // Arama başlat/durdur
  async toggleSearch() {
    if (this.searching) {
      // Aramayı durdur
      this.searching = false;
      this.waitingAnimation = false;
      
      // Socket'e aramayı durdurduğumuzu bildir
      if (this.socket) {
        this.socket.emit('stop-search', { userId: this.user?.id });
      }
      
      // Eşleşme kontrolünü durdur
      if (this.matchCheckInterval) {
        clearInterval(this.matchCheckInterval);
        this.matchCheckInterval = null;
      }
      
      this.showToast('Arama durduruldu', 'info');
    } else {
      // Kullanıcı girişi yapılmış mı kontrol et
      if (!this.user || !this.user.id) {
        this.showToast('Arama başlatmak için giriş yapmalısınız', 'warning');
        return;
      }
      
      try {
        // Aramayı başlat
        this.searching = true;
        this.waitingAnimation = true;
        
        // API ile eşleşme başlat
        await this.startSearch();
        
        this.showToast('Eşleşme aranıyor...', 'info');
      } catch (err) {
        console.error('Arama başlatma hatası:', err);
        this.showToast('Arama başlatılırken bir hata oluştu', 'error');
        this.searching = false;
        this.waitingAnimation = false;
      }
    }
  },
  // Aramayı iptal et
  async cancelSearch() {
    try {
      if (!this.searching) return;
      
      this.searching = false;
      this.waitingAnimation = false;
      
      // Sunucuya bildir
      await fetch('/api/match/cancel', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: this.user.id
        })
      });
      
      this.showToast('Arama iptal edildi', 'info');
    } catch (err) {
      console.error('Arama iptal hatası:', err);
      this.showToast('Arama iptal edilirken bir hata oluştu', 'error');
    }
  },
  // Aramayı iptal et
  async startSearch() {
    try {
      // Kullanıcı kontrolü
      if (!this.user || !this.user.id) {
        this.showToast('Aramalara katılmak için giriş yapmalısınız', 'warning');
        this.searching = false;
        return false;
      }
      
      // Yerel socket bağlantısı 
      if (!this.socket) {
        this.socket = await this.setupSocketConnection();
      }
      
      // Mock socket için biraz bekleyelim ve ardından bir eşleşme simüle edelim
      if (this.socket && typeof this.socket.mockTrigger === 'function') {
        this.showToast('Eşleşme aranıyor...', 'info');
        
        // Eşleşme kontrolü için zamanlayıcı
        this.matchCheckInterval = setInterval(() => {
          const matchData = {
            status: 'matched', 
            roomId: 'mock_room_' + Date.now(),
            peerId: 'mock_peer_id_' + Math.random().toString(36).substr(2, 9),
            peerEmail: 'misafir@example.com',
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' }
            ]
          };
          
          this.handleMatchFound(matchData);
          
          // Eşleşme bulundu, zamanlayıcıyı durdur
          clearInterval(this.matchCheckInterval);
          this.matchCheckInterval = null;
        }, 3000);
        
        return true;
      }
      
      // Gelişmiş özellikleri devre dışı bıraktık
      this.showToast('Bu özellik şu anda kullanılamıyor. Lütfen daha sonra tekrar deneyin.', 'warning');
      return false;
    } catch (err) {
      console.error('Arama başlatma hatası:', err);
      this.showToast('Arama başlatılırken bir hata oluştu', 'error');
      this.searching = false;
      this.waitingAnimation = false;
      return false;
    }
  },
  // Eşleşme bulunduğunda
  async handleMatchFound(matchData) {
    try {
      console.log('Eşleşme bulundu:', matchData);
      
      // Eşleşme verilerini kaydet
      this.currentRoomId = matchData.roomId;
      this.currentPeerId = matchData.peerId;
      
      // Önceki bağlantıları temizle
      await this.cleanupConnections();
      
      // Mock socket kontrolü
      if (this.socket) {
        if (typeof this.socket.mockTrigger !== 'function') {
          // Gerçek socket - room'a katıl
          this.socket.emit('join-room', {
            roomId: this.currentRoomId,
            userId: this.user.id,
            email: this.user.email
          });
        } else {
          // Mock socket - doğrudan WebRTC kurulumuna geç
          await this.setupWebRTC(matchData.iceServers);
          // Uzak tarafın direkt olarak bağlandığını varsay
          setTimeout(() => {
            this.showToast('Görüntülü sohbet başlatıldı', 'success');
            this.inCall = true;
            this.searching = false;
            this.waitingAnimation = false;
          }, 2000);
        }
      }
      
      return true;
    } catch (err) {
      console.error('Eşleşme işleme hatası:', err);
      return false;
    }
  },
  // Yerel video akışını kur
  async setupLocalStream() {
    try {
      if (this.localStream) {
        // Önceki akışı temizle
        this.localStream.getTracks().forEach(track => track.stop());
      }
      
      // Medya erişimi iste
      this.localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });
      
      // Yerel video elementini ayarla
      const localVideo = document.getElementById('localVideo');
      if (localVideo) {
        localVideo.srcObject = this.localStream;
      }
      
      // Önizleme videosunu ayarla (eğer varsa)
      const previewVideo = document.getElementById('previewVideo');
      if (previewVideo) {
        previewVideo.srcObject = this.localStream;
      }
      
      // Kamera ve mikrofon durumunu ayarla
      if (this.isVideoOff) {
        this.localStream.getVideoTracks().forEach(track => {
          track.enabled = false;
        });
      }
      
      if (this.isMuted) {
        this.localStream.getAudioTracks().forEach(track => {
          track.enabled = false;
        });
      }
      
      console.log('Yerel medya akışı kuruldu');
    } catch (err) {
      console.error('Medya erişimi hatası:', err);
      this.showToast('Kamera ve mikrofon erişimi sağlanamadı', 'error');
      throw err;
    }
  },
  // WebRTC bağlantısını kur
  async setupWebRTC(iceServers = null) {
    try {
      if (!iceServers) {
        iceServers = [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ];
      }
      
      // Yerel medya akışını kurma
      if (!this.localStream) {
        try {
          this.localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
          });
          
          // Yerel videoyu göster
          const localVideo = document.getElementById('localVideo');
          if (localVideo) {
            localVideo.srcObject = this.localStream;
          }
          
          console.log('Yerel medya akışı kuruldu');
        } catch (err) {
          console.error('Kamera/mikrofon erişimi hatası:', err);
          
          // Sadece ses ile devam et
          try {
            this.localStream = await navigator.mediaDevices.getUserMedia({
              video: false,
              audio: true
            });
            this.isVideoOff = true;
            this.showToast('Kamera erişimi sağlanamadı, ses ile devam ediliyor', 'warning');
          } catch (audioErr) {
            console.error('Ses erişimi hatası:', audioErr);
            this.showToast('Mikrofon erişimi sağlanamadı', 'error');
            throw audioErr;
          }
        }
      }
      
      // Mock sistemde, 2 saniye içinde uzaktan video akışı göster
      if (!this.socket || typeof this.socket.mockTrigger === 'function') {
        // Yerel video akışını klonlayarak uzaktan gelen gibi göster (demo amaçlı)
        setTimeout(() => {
          try {
            // Gerçek bir peer olmadığı için, yerel akışın bir kopyasını uzak akış gibi göster
            this.remoteStream = this.localStream.clone();
            
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) {
              remoteVideo.srcObject = this.remoteStream;
              
              // Kamera aktif duruma getir
              this.peerVideoOff = false;
              this.inCall = true;
              
              this.showToast('Görüntülü görüşme başladı', 'success');
            }
          } catch (err) {
            console.error('Demo video oluşturma hatası:', err);
          }
        }, 2000);
        
        return true;
      }
      
      // Gerçek WebRTC akışı (socket.io aktif olduğunda)
      this.peerConnection = new RTCPeerConnection({
        iceServers: iceServers
      });
      
      // Yerel medya akışını peer bağlantısına ekle
      this.localStream.getTracks().forEach(track => {
        this.peerConnection.addTrack(track, this.localStream);
      });
      
      // Uzak tarafın medya akışını dinle
      this.peerConnection.ontrack = (event) => {
        console.log('Uzak taraftan medya akışı alındı');
        this.remoteStream = event.streams[0];
        
        // Uzak videoyu göster
        const remoteVideo = document.getElementById('remoteVideo');
        if (remoteVideo) {
          remoteVideo.srcObject = this.remoteStream;
        }
        
        this.peerVideoOff = false;
      };
      
      // ICE aday olaylarını dinle
      this.peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          if (this.socket) {
            // Mock socket kontrolü
            if (typeof this.socket.mockTrigger !== 'function') {
              this.socket.emit('ice-candidate', {
                roomId: this.currentRoomId,
                candidate: event.candidate,
                userId: this.user.id,
                peerId: this.currentPeerId
              });
            } else {
              console.log('Mock socket - ICE adayı gönderildi (simülasyon)');
            }
          }
        }
      };
      
      // Bağlantı durumu değişikliğini dinle
      this.peerConnection.onconnectionstatechange = () => {
        console.log('WebRTC bağlantı durumu:', this.peerConnection.connectionState);
        
        if (this.peerConnection.connectionState === 'connected') {
          this.showToast('Bağlantı kuruldu', 'success');
          this.inCall = true;
          this.searching = false;
          this.waitingAnimation = false;
        } else if (this.peerConnection.connectionState === 'disconnected' || 
                  this.peerConnection.connectionState === 'failed') {
          this.showToast('Bağlantı kesildi', 'error');
          this.inCall = false;
          this.cleanupConnections();
        }
      };
      
      return true;
    } catch (err) {
      console.error('WebRTC kurulum hatası:', err);
      this.showToast('Kamera ve mikrofon erişimi gereklidir', 'error');
      return false;
    }
  },
  // Önceki bağlantıları temizle
  async cleanupConnections() {
    console.log('Önceki bağlantılar temizleniyor');
    
    try {
      // Peer bağlantısını kapat
      if (this.peerConnection) {
        if (this.peerConnection.getTransceivers) {
          this.peerConnection.getTransceivers().forEach(transceiver => {
            if (transceiver.stop) {
              transceiver.stop();
            }
          });
        }
        
        // Tüm track'leri kapat
        if (this.peerConnection.getSenders) {
          this.peerConnection.getSenders().forEach(sender => {
            if (sender.track) {
              sender.track.stop();
            }
          });
        }
        
        this.peerConnection.close();
        this.peerConnection = null;
      }
      
      // Uzak akışı temizle
      if (this.remoteStream) {
        this.remoteStream.getTracks().forEach(track => track.stop());
        this.remoteStream = null;
      }
      
      console.log('Önceki bağlantılar temizlendi');
      return true;
    } catch (err) {
      console.error('Bağlantı temizleme hatası:', err);
      return false;
    }
  },
  // Görüşmeyi sonlandır ve yeni eşleşme bul
  async endCall() {
    try {
      if (!this.inCall) return;
      
      // Sunucuya bildir
      if (this.currentRoomId) {
        await fetch('/api/end-call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: this.user.id,
            roomId: this.currentRoomId,
            autoRequeue: true // Otomatik olarak yeniden sıraya gir
          })
        });
      }
      
      // Bağlantıları temizle
      await this.cleanupConnections();
      
      // UI'ı sıfırla
      this.inCall = false;
      this.searching = false;
      this.peerVideoOff = true;
      
      // Otomatik olarak eşleşme sırasına gir
      this.waitingAnimation = true;
      this.showToast('Yeni eşleşme için sıraya alındınız', 'info');
      
      // Kısa bir gecikme ekle
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Eşleşme ara
      this.startSearch();
    } catch (err) {
      console.error('Görüşme sonlandırma hatası:', err);
      this.showToast('Görüşme sonlandırılırken bir hata oluştu', 'error');
    }
  },
  // Görüşmeyi sonlandır ve anasayfaya dön
  async endCallWithoutRequeue() {
    try {
      if (!this.inCall) return;
      
      // Sunucuya bildir
      if (this.currentRoomId) {
        await fetch('/api/end-call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: this.user.id,
            roomId: this.currentRoomId,
            autoRequeue: false // Otomatik olarak yeniden sıraya girme
          })
        });
      }
      
      // Bağlantıları temizle
      await this.cleanupConnections();
      
      // UI'ı sıfırla
      this.inCall = false;
      this.searching = false;
      this.waitingAnimation = false;
      this.peerVideoOff = true;
      
      this.showToast('Görüşme sonlandırıldı', 'info');
    } catch (err) {
      console.error('Görüşme sonlandırma hatası:', err);
      this.showToast('Görüşme sonlandırılırken bir hata oluştu', 'error');
    }
  },
  // Mikrofonu aç/kapat
  toggleMic() {
    try {
      if (!this.localStream) return;
      
      this.isMuted = !this.isMuted;
      
      // Ses parçalarını aç/kapat
      this.localStream.getAudioTracks().forEach(track => {
        track.enabled = !this.isMuted;
      });
      
      // Karşı tarafa bildir
      if (this.socket && this.currentRoomId) {
        this.socket.emit('audio-status', {
          roomId: this.currentRoomId,
          isMuted: this.isMuted
        });
      }
      
      this.showToast(this.isMuted ? 'Mikrofon kapatıldı' : 'Mikrofon açıldı', 'info');
    } catch (err) {
      console.error('Mikrofon değiştirme hatası:', err);
      this.showToast('Mikrofon durumu değiştirilirken bir hata oluştu', 'error');
    }
  },
  // Kamerayı aç/kapat
  toggleVideo() {
    try {
      if (!this.localStream) return;
      
      this.isVideoOff = !this.isVideoOff;
      
      // Video parçalarını aç/kapat
      this.localStream.getVideoTracks().forEach(track => {
        track.enabled = !this.isVideoOff;
      });
      
      // Karşı tarafa bildir
      if (this.socket && this.currentRoomId) {
        this.socket.emit('video-status', {
          roomId: this.currentRoomId,
          isVideoOff: this.isVideoOff
        });
      }
      
      this.showToast(this.isVideoOff ? 'Kamera kapatıldı' : 'Kamera açıldı', 'info');
    } catch (err) {
      console.error('Kamera değiştirme hatası:', err);
      this.showToast('Kamera durumu değiştirilirken bir hata oluştu', 'error');
    }
  },
  // Socket.io bağlantısını kur
  async setupSocketConnection() {
    try {
      // Kullanıcı bilgilerinin hazır olmasını bekle
      if (!this.user) {
        if (window.UserData) {
          this.user = window.UserData;
        } else {
          console.log('Kullanıcı bilgileri hazır değil');
          return null;
        }
      }
      
      // Mock socket kullan (gerçek socket.io bağlantısı kurulamadığında)
      this.socket = new window.MockSocket();
      console.log('Mock socket.io bağlantısı kuruldu');
      
      // Varsayılan mock olayları tanımla (eşleşme bulunuyor gibi)
      setTimeout(() => {
        // Birkaç saniye sonra sahte eşleşme yap
        if (this.socket && typeof this.socket.mockTrigger === 'function') {
          this.socket.mockTrigger('match-found', {
            status: 'matched', 
            roomId: 'mock_room_' + Date.now(),
            peerId: 'mock_peer_id',
            peerEmail: 'misafir@example.com',
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' }
            ]
          });
        }
      }, 5000);
      
      return this.socket;
    } catch (err) {
      console.error('Socket.io bağlantı hatası:', err);
      return null;
    }
  },
  // Cleanup before unload
  cleanupBeforeUnload() {
    try {
      // WebRTC bağlantısını kapat
      if (this.peerConnection) {
        this.peerConnection.close();
        this.peerConnection = null;
      }
      
      // Yerel video akışını durdur
      if (this.localStream) {
        this.localStream.getTracks().forEach(track => {
          track.stop();
        });
        this.localStream = null;
      }
      
      // Uzak video akışını temizle
      if (this.remoteStream) {
        this.remoteStream.getTracks().forEach(track => {
          track.stop();
        });
        this.remoteStream = null;
      }
      
      // Eşleşme kontrolünü temizle
      if (this.matchCheckInterval) {
        clearInterval(this.matchCheckInterval);
        this.matchCheckInterval = null;
      }
      
      // Oda ve eşleşme bilgilerini temizle
      this.currentRoomId = null;
      this.currentPeerId = null;
      
      // Peer video durumunu sıfırla
      this.peerVideoOff = true;
      
      console.log('Önceki bağlantılar temizlendi');
    } catch (err) {
      console.error('Bağlantı temizleme hatası:', err);
    }
  },
  // Tema değiştirme
  toggleTheme() {
    this.darkMode = !this.darkMode;
    localStorage.setItem('darkMode', this.darkMode.toString());
  },
  // Kullanıcı verilerini yükle
  async loadUserData() {
    try {
      const supabaseClient = supabase.createClient(
        'https://unrfzoyltrqoyumrbhjo.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVucmZ6b3lsdHJxb3l1bXJiaGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5NDg5NDEsImV4cCI6MjA1NjUyNDk0MX0.4p18-Ohwnerg-qUpKr4f4TQWVWKBJtSdTdmDaoTJLDE'
      );
      
      // URL parametrelerini kontrol et
      const params = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = params.get('access_token');
      
      if (accessToken) {
        console.log('OAuth yanıtı işleniyor...');
        await supabaseClient.auth.setSession({
          access_token: accessToken,
          refresh_token: params.get('refresh_token')
        });
        
        // URL'yi temizle
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Kullanıcı bilgilerini al
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      
      if (error) {
        console.error('Kullanıcı bilgisi alınamadı:', error);
        return;
      }
      
      if (user) {
        console.log('Kullanıcı bilgileri alındı:', user);
        
        this.user = {
          id: user.id,
          email: user.email,
          avatar: user.user_metadata?.avatar_url,
          name: user.user_metadata?.full_name
        };
        
        // Global değişkeni güncelle
        window.UserData = this.user;
        
        this.showToast('Giriş başarılı!', 'success');
      } else {
        console.log('Oturum açmış kullanıcı yok');
        this.user = null;
      }
    } catch (err) {
      console.error('Kullanıcı bilgileri yükleme hatası:', err);
    }
  },
  // Olay dinleyicilerini kur
  setupEventListeners() {
    // URL hash değişikliği olduğunda kullanıcı verilerini kontrol et
    window.addEventListener('hashchange', () => {
      this.loadUserData();
    });
  },
  // Mesaj gönderme fonksiyonu 
  sendMessage() {
    if (this.messageText.trim() === '') return;
    
    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
    
    // Yeni mesajı ekle
    const newMessage = {
      text: this.messageText,
      time: timeStr,
      isMe: true
    };
    
    this.messages.push(newMessage);
    
    // Socket varsa mesajı gönder
    if (this.socket) {
      this.socket.emit('send-message', {
        roomId: this.currentRoomId,
        message: this.messageText,
        userId: this.user?.id,
        senderName: this.user?.name || 'Misafir'
      });
    }
    
    // Mock sistemde, karşıdan gelen cevap ekleyelim
    if (this.socket && typeof this.socket.mockTrigger === 'function') {
      setTimeout(() => {
        const responses = [
          "Merhaba, nasılsın?",
          "Anladım, devam et lütfen.",
          "Bu çok ilginç!",
          "Seninle konuşmak güzel.",
          "Daha fazla bilgi verebilir misin?"
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        
        const mockMessage = {
          text: randomResponse,
          time: timeStr,
          isMe: false
        };
        
        this.messages.push(mockMessage);
        
        // Mesaj listesini aşağı kaydır
        this.scrollToBottom();
      }, 1000);
    }
    
    // Input alanını temizle
    this.messageText = '';
    
    // Mesaj listesini aşağı kaydır
    this.$nextTick(() => {
      this.scrollToBottom();
    });
  },
  // Mesaj listesini en alta kaydır
  scrollToBottom() {
    const messageList = document.getElementById('messageList');
    if (messageList) {
      messageList.scrollTop = messageList.scrollHeight;
    }
  }
}" :class="darkMode ? 'dark' : ''" x-init="loadUserData(); setupEventListeners()">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-900 shadow-md py-4">
    <div class="container mx-auto flex justify-between items-center px-4">
      <div class="logo flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Opia
      </div>
      <div class="flex items-center">
        <!-- Tema değiştirme butonu -->
        <button @click="toggleTheme()" class="p-2 rounded-full hover:bg-indigo-700">
          <svg x-show="!darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
          <svg x-show="darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </button>
        
        <!-- Kullanıcı giriş yapmadıysa Google ile giriş butonu göster -->
        <button 
          x-show="!user"
          @click="login()" 
          class="flex items-center space-x-2 bg-white text-gray-800 px-4 py-2 ml-4 rounded-lg hover:bg-gray-100"
        >
          <svg width="20" height="20" viewBox="0 0 24 24">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          <span>Google ile Giriş Yap</span>
        </button>
        
        <!-- Kullanıcı giriş yapmışsa e-posta adresi ve avatar göster -->
        <div 
          x-show="user" 
          class="flex items-center space-x-2 bg-indigo-600 bg-opacity-50 text-white px-4 py-2 ml-4 rounded-lg"
        >
          <template x-if="user?.avatar">
            <img :src="user.avatar" class="w-8 h-8 rounded-full border-2 border-white">
          </template>
          <template x-if="!user?.avatar">
            <div class="w-8 h-8 rounded-full bg-indigo-800 flex items-center justify-center text-white font-bold">
              <span x-text="user?.email?.charAt(0).toUpperCase()"></span>
            </div>
          </template>
          <span x-text="user?.email"></span>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- Ana Sayfa -->
    <div x-show="!inCall" class="h-full flex flex-col items-center justify-center">
      <div class="text-center mb-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-2">Opia Görüntülü ve Sesli Sohbet</h2>
        <p class="text-gray-600 dark:text-gray-400">Rastgele kişilerle görüntülü sohbet edin</p>
      </div>
      
      <!-- Bekleme Animasyonu -->
      <div x-show="waitingAnimation" class="mb-8">
        <div class="flex items-center justify-center">
          <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
        </div>
        <p class="mt-4 text-indigo-600 dark:text-indigo-400 font-medium">Eşleşme bekleniyor...</p>
      </div>
      
      <!-- Giriş sonrası kullanıcı bilgisi gösterimi -->
      <div x-show="user" class="flex items-center space-x-2 mb-4">
        <template x-if="user?.avatar">
          <img :src="user.avatar" class="w-8 h-8 rounded-full">
        </template>
        <span class="text-gray-700 dark:text-gray-300" x-text="user?.email || 'Misafir Kullanıcı'"></span>
      </div>
      
      <!-- Kamera ve Mikrofon Kontrolleri -->
      <div class="flex space-x-4 mb-6">
        <button 
          @click="toggleCameraPreview()" 
          class="flex items-center justify-center px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
        >
          <svg x-show="!localStream || isVideoOff" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          <svg x-show="localStream && !isVideoOff" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
          </svg>
          <span x-text="localStream && !isVideoOff ? 'Kamerayı Kapat' : 'Kamerayı Aç'"></span>
        </button>
        
        <button 
          @click="toggleMicPreview()" 
          class="flex items-center justify-center px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
        >
          <svg x-show="!localStream || isMuted" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
          <svg x-show="localStream && !isMuted" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
          </svg>
          <span x-text="localStream && !isMuted ? 'Mikrofonu Kapat' : 'Mikrofonu Aç'"></span>
        </button>
      </div>
      
      <!-- Kamera Önizleme -->
      <div x-show="localStream && !isVideoOff && !inCall" class="mb-6 relative w-64 h-48 rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-700">
        <video 
          id="previewVideo" 
          class="w-full h-full object-cover video-mirror"
          autoplay
          playsinline
          muted
        ></video>
      </div>
      
      <div class="space-y-4">
        <button
          x-show="!searching" 
          @click="toggleSearch()" 
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105"
        >
          Arama Başlat
        </button>
        
        <button
          x-show="searching" 
          @click="cancelSearch()" 
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105"
        >
          Aramayı İptal Et
        </button>
      </div>
    </div>

    <!-- Görüşme Ekranı -->
    <div x-show="inCall" class="h-full flex flex-col">
      <!-- Kontroller -->
      <div class="flex justify-center space-x-4 mb-4">
        <button 
          @click="toggleMic()" 
          class="btn-secondary p-3 rounded-full"
        >
          <svg x-show="!isMuted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
          <svg x-show="isMuted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
          </svg>
        </button>
        
        <button @click="toggleVideo()" class="btn-secondary p-3 rounded-full">
          <span x-show="!isVideoOff">Kamerayı Kapat</span>
          <span x-show="isVideoOff">Kamerayı Aç</span>
        </button>
        
        <button 
          @click="endCallWithoutRequeue()" 
          x-show="inCall"
          class="bg-red-500 text-white p-3 rounded-full hover:bg-red-600"
        >
          Görüşmeyi Sonlandır
        </button>
        
        <button 
          @click="endCall()" 
          x-show="inCall"
          class="bg-indigo-500 text-white p-3 rounded-full hover:bg-indigo-600"
        >
          Yeni Eşleşme Bul
        </button>
      </div>

      <!-- Video ve Sohbet Grid -->
      <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-4 max-h-[calc(100vh-200px)]">
        <!-- Yerel Video -->
        <div class="relative bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden lg:col-span-1">
          <video 
            id="localVideo" 
            class="w-full h-full object-cover video-mirror"
            autoplay
            playsinline
            muted
          ></video>
          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-center py-1">
            Siz <span x-text="user?.name || 'Misafir'"></span>
          </div>
        </div>
        
        <!-- Uzak Video -->
        <div class="relative bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden lg:col-span-1">
          <video 
            id="remoteVideo" 
            class="w-full h-full object-cover"
            autoplay
            playsinline
          ></video>
          <div 
            x-show="!peerVideoOff" 
            class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-center py-1"
          >
            Karşı Taraf
          </div>
          <div 
            x-show="peerVideoOff || !inCall" 
            class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 text-white text-center"
          >
            <div>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
              <p x-show="!inCall">Henüz bir görüşme başlatılmadı</p>
              <p x-show="inCall && peerVideoOff">Karşı taraf kamerasını kapattı</p>
            </div>
          </div>
        
        <!-- Chat Alanı -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg flex flex-col lg:col-span-1 h-[calc(100vh-200px)]">
          <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="font-bold text-lg">Sohbet</h3>
          </div>
          
          <!-- Mesaj Listesi -->
          <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messageList">
            <template x-for="(message, index) in messages" :key="index">
              <div :class="{
                'flex flex-col': true,
                'items-end': message.isMe,
                'items-start': !message.isMe
              }">
                <div :class="{
                  'max-w-xs rounded-lg p-3': true,
                  'bg-indigo-500 text-white': message.isMe,
                  'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white': !message.isMe
                }">
                  <p x-text="message.text"></p>
                </div>
                <span class="text-xs text-gray-500 mt-1" x-text="message.time"></span>
              </div>
            </template>
            
            <!-- Boş durumda gösterilecek -->
            <div x-show="messages.length === 0" class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              <p>Henüz mesaj yok</p>
            </div>
          </div>
          
          <!-- Mesaj Gönderme Formu -->
          <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <form @submit.prevent="sendMessage()" class="flex">
              <input 
                type="text" 
                x-model="messageText" 
                placeholder="Mesajınızı yazın..." 
                class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-white"
                :disabled="!inCall"
              >
              <button 
                type="submit" 
                class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-r-lg"
                :disabled="!inCall"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                </svg>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Footer -->
  <footer class="bg-gray-100 dark:bg-gray-800 py-4 text-center text-gray-600 dark:text-gray-400 text-sm">
    <div class="container mx-auto">
      <p>&copy; 2025 Opia. Tüm hakları saklıdır.</p>
    </div>
  </footer>
  
  <!-- Toast Notifications -->
  <div class="fixed top-4 right-4 z-50 flex flex-col space-y-2">
    <template x-for="toast in toasts" :key="toast.id">
      <div 
        :class="{
          'bg-green-500': toast.type === 'success',
          'bg-blue-500': toast.type === 'info',
          'bg-yellow-500': toast.type === 'warning',
          'bg-red-500': toast.type === 'error'
        }"
        class="text-white px-4 py-2 rounded shadow-lg transition-all duration-500 transform translate-x-0"
      >
        <span x-text="toast.message"></span>
      </div>
    </template>
  </div>
</body>
</html>
