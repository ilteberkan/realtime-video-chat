<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Opia - Görüntülü ve Sesli Sohbet</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <!-- Favicon -->
  <link rel="icon" href="data:,">
  <style>
    :root {
      --color-bg: #ffffff;
      --color-text: #333333;
      --color-primary: #4f46e5;
      --color-secondary: #818cf8;
      --color-accent: #c7d2fe;
      --color-card: #f3f4f6;
    }
    
    .dark {
      --color-bg: #1f2937;
      --color-text: #f3f4f6;
      --color-primary: #6366f1;
      --color-secondary: #818cf8;
    }
    
    body {
      background-color: var(--color-bg);
      color: var(--color-text);
    }
    
    .logo {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--color-primary);
    }
    
    .logo svg {
      width: 40px;
      height: 40px;
      vertical-align: middle;
      margin-right: 8px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col" x-data="{
  darkMode: localStorage.getItem('darkMode') === 'true',
  user: null,
  inCall: false,
  searching: false,
  isMuted: false,
  isVideoOff: false,
  peerVideoOff: true,
  messages: [],
  messageText: '',
  toasts: [],
  isAdmin: false,
  waitingAnimation: false,
  // Medya akışları
  localStream: null,
  remoteStream: null,
  // WebRTC bağlantısı
  peerConnection: null,
  socket: null,
  currentRoomId: null,
  currentPeerId: null,
  // Zamanlayıcılar
  matchCheckInterval: null,
  toastTimeout: null,
  // Diğer değişkenler
  continuousSearch: false,
  // Bildirim göster
  showToast(message, type = 'info') {
    try {
      if (!this.toasts) {
        this.toasts = [];
      }
      
      const id = Date.now();
      this.toasts.push({ id, message, type });
      
      // 3 saniye sonra bildirimi kaldır
      setTimeout(() => {
        this.toasts = this.toasts.filter(toast => toast.id !== id);
      }, 3000);
    } catch (err) {
      console.error('Toast gösterme hatası:', err);
    }
  },
  // Giriş işlemi
  async login() {
    try {
      const supabaseClient = supabase.createClient(
        'https://unrfzoyltrqoyumrbhjo.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVucmZ6b3lsdHJxb3l1bXJiaGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5NDg5NDEsImV4cCI6MjA1NjUyNDk0MX0.4p18-Ohwnerg-qUpKr4f4TQWVWKBJtSdTdmDaoTJLDE'
      );

      const { data, error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin,
          queryParams: {
            access_type: 'offline',
            prompt: 'consent'
          }
        }
      });

      if (error) throw error;
      
      // Yönlendirme sonrası kullanıcı bilgilerini al
      const { data: { user: userData } } = await supabaseClient.auth.getUser();
      
      if(userData) {
        this.user = {
          id: userData.id,
          email: userData.email,
          avatar: userData.user_metadata?.avatar_url,
          name: userData.user_metadata?.full_name
        };
        this.showToast('Giriş başarılı!', 'success');
      }
    } catch (err) {
      console.error('Giriş hatası:', err);
      this.showToast('Giriş başarısız: ' + err.message, 'error');
    }
  },
  // Çıkış yap
  async logout() {
    try {
      await supabase.createClient(
        'https://unrfzoyltrqoyumrbhjo.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVucmZ6b3lsdHJxb3l1bXJiaGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5NDg5NDEsImV4cCI6MjA1NjUyNDk0MX0.4p18-Ohwnerg-qUpKr4f4TQWVWKBJtSdTdmDaoTJLDE'
      ).auth.signOut();
      this.user = null;
      this.isAdmin = false;
      
      // Aktif bağlantıları temizle
      if (this.inCall) {
        await this.endCall();
      }
      
      if (this.searching) {
        await this.cancelSearch();
      }
      
      this.showToast('Başarıyla çıkış yapıldı', 'success');
      
      // Sayfayı yenile
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    } catch (err) {
      console.error('Çıkış hatası:', err);
      this.showToast('Çıkış yapılırken bir hata oluştu', 'error');
    }
  },
  // Arama başlat/durdur
  async toggleSearch() {
    try {
      if (this.searching) {
        await this.cancelSearch();
      } else {
        await this.startSearch();
      }
    } catch (err) {
      console.error('Arama başlatma/durdurma hatası:', err);
      this.showToast('Arama başlatılırken/durdurulurken bir hata oluştu', 'error');
    }
  },
  // Aramayı iptal et
  async cancelSearch() {
    try {
      if (!this.searching) return;
      
      this.searching = false;
      this.waitingAnimation = false;
      
      // Sunucuya bildir
      await fetch('/api/match/cancel', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: this.user.id
        })
      });
      
      this.showToast('Arama iptal edildi', 'info');
    } catch (err) {
      console.error('Arama iptal hatası:', err);
      this.showToast('Arama iptal edilirken bir hata oluştu', 'error');
    }
  },
  // Eşleşme aramayı başlat
  async startSearch() {
    try {
      if (this.searching) return;
      
      this.searching = true;
      this.waitingAnimation = true;
      
      // Medya erişimi al (eğer yoksa)
      if (!this.localStream) {
        try {
          await this.setupLocalStream();
        } catch (err) {
          console.error('Medya erişimi hatası:', err);
          this.showToast('Kamera ve mikrofon erişimi olmadan devam ediliyor', 'warning');
        }
      }
      
      // Socket.io bağlantısını kontrol et ve gerekirse yeniden kur
      if (!this.socket) {
        await this.setupSocketConnection();
      }
      
      // Eşleşme isteği gönder
      const response = await fetch('/api/match', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          userId: this.user.id,
          email: this.user.email
        })
      });
      
      const data = await response.json();
      
      if (data.status === 'matched') {
        // Eşleşme gerçekten var mı kontrol et
        if (!data.peerId) {
          console.error('Eşleşme bulunamadı: Peer ID eksik');
          this.showToast('Eşleşme bulunamadı, sıraya alındınız', 'info');
          return;
        }
        
        // Eşleşme bulundu
        await this.handleMatchFound(data);
        this.waitingAnimation = false;
      } else if (data.status === 'queued') {
        // Kuyruğa alındı
        this.showToast(`Sıraya alındınız. Sıra numaranız: ${data.queuePosition}`, 'info');
        
        // Eşleşme durumunu kontrol etmek için interval başlat
        if (this.matchCheckInterval) {
          clearInterval(this.matchCheckInterval);
        }
        
        this.matchCheckInterval = setInterval(async () => {
          try {
            const statusResponse = await fetch('/api/match/status', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                userId: this.user.id
              })
            });
            
            const statusData = await statusResponse.json();
            
            if (statusData.status === 'matched') {
              // Eşleşme gerçekten var mı kontrol et
              if (!statusData.peerId) {
                console.error('Eşleşme bulunamadı: Peer ID eksik');
                return;
              }
              
              // Eşleşme bulundu
              clearInterval(this.matchCheckInterval);
              this.matchCheckInterval = null;
              await this.handleMatchFound(statusData);
              this.waitingAnimation = false;
            }
          } catch (err) {
            console.error('Eşleşme durumu kontrol hatası:', err);
          }
        }, 2000); // 2 saniyede bir kontrol et
      } else if (data.status === 'already-in-queue') {
        // Zaten kuyrukta
        this.showToast(`Zaten sıradasınız. Sıra numaranız: ${data.queuePosition}`, 'info');
      }
    } catch (err) {
      console.error('Eşleşme başlatma hatası:', err);
      this.showToast('Eşleşme başlatılırken bir hata oluştu', 'error');
      this.searching = false;
      this.waitingAnimation = false;
    }
  },
  // Eşleşme bulunduğunda
  async handleMatchFound(data) {
    try {
      console.log('Eşleşme bulundu:', data);
      
      // Eşleşme verilerini kontrol et
      if (!data.roomId || !data.peerId) {
        console.error('Geçersiz eşleşme verileri:', data);
        this.showToast('Eşleşme verileri eksik, yeniden deneniyor', 'error');
        
        // Eşleşme aramayı yeniden başlat
        this.searching = false;
        this.waitingAnimation = true;
        setTimeout(() => this.startSearch(), 1000);
        return;
      }
      
      // Önceki eşleşme bilgilerini temizle
      this.cleanupPreviousConnections();
      
      this.currentRoomId = data.roomId;
      this.currentPeerId = data.peerId;
      this.inCall = true;
      this.searching = false;
      this.peerVideoOff = true;
      
      // Yerel video akışını kontrol et
      if (!this.localStream) {
        await this.setupLocalStream();
      }
      
      // Socket.io bağlantısını kontrol et ve gerekirse yeniden kur
      if (!this.socket) {
        await this.setupSocketConnection();
      }
      
      // Kullanıcı bilgisini ayarla
      this.socket.emit('set-user', {
        id: this.user.id,
        email: this.user.email
      });
      
      // Odaya katıl
      this.socket.emit('join-room', data.roomId);
      
      // Kısa bir gecikme ekle
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // WebRTC bağlantısını kur
      await this.setupPeerConnection(data.iceServers);
      
      // ID'leri karşılaştırarak kimin offer göndereceğini belirle
      const shouldSendOffer = this.user.id < data.peerId;
      
      if (shouldSendOffer) {
        console.log('Offer gönderiyoruz (ID daha küçük)');
        // Offer oluştur
        const offer = await this.peerConnection.createOffer({
          offerToReceiveAudio: true,
          offerToReceiveVideo: true
        });
        
        // Yerel açıklamayı ayarla
        await this.peerConnection.setLocalDescription(offer);
        
        // Offer'ı odaya gönder
        this.socket.emit('offer', {
          roomId: this.currentRoomId,
          sdp: offer
        });
        
        console.log('Offer gönderildi');
      } else {
        console.log('Offer bekliyoruz (ID daha büyük)');
      }
      
      this.showToast('Eşleşme bulundu!', 'success');
    } catch (err) {
      console.error('Eşleşme işleme hatası:', err);
      this.showToast('Eşleşme sırasında bir hata oluştu', 'error');
      this.inCall = false;
      this.searching = false;
      
      // Eşleşme aramayı yeniden başlat
      this.waitingAnimation = true;
      setTimeout(() => this.startSearch(), 2000);
    }
  },
  // Yerel video akışını kur
  async setupLocalStream() {
    try {
      if (this.localStream) {
        // Önceki akışı temizle
        this.localStream.getTracks().forEach(track => track.stop());
      }
      
      // Medya erişimi iste
      this.localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });
      
      // Yerel video elementini ayarla
      const localVideo = document.getElementById('localVideo');
      if (localVideo) {
        localVideo.srcObject = this.localStream;
      }
      
      // Önizleme videosunu ayarla (eğer varsa)
      const previewVideo = document.getElementById('previewVideo');
      if (previewVideo) {
        previewVideo.srcObject = this.localStream;
      }
      
      // Kamera ve mikrofon durumunu ayarla
      if (this.isVideoOff) {
        this.localStream.getVideoTracks().forEach(track => {
          track.enabled = false;
        });
      }
      
      if (this.isMuted) {
        this.localStream.getAudioTracks().forEach(track => {
          track.enabled = false;
        });
      }
      
      console.log('Yerel medya akışı kuruldu');
    } catch (err) {
      console.error('Medya erişimi hatası:', err);
      this.showToast('Kamera ve mikrofon erişimi sağlanamadı', 'error');
      throw err;
    }
  },
  // WebRTC bağlantısını kur
  async setupPeerConnection(iceServers) { 
    try {
      if (this.peerConnection) {
        this.peerConnection.close();
        this.peerConnection = null;
      }

      // Socket bağlantısı yoksa hata fırlat
      if (!this.socket) {
        throw new Error('Socket bağlantısı kurulmadan WebRTC bağlantısı kurulamaz');
      }
      
      // PeerConnection oluştur
      this.peerConnection = new RTCPeerConnection({
        iceServers: iceServers || [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });
      
      // Yerel medya akışını ekle
      if (this.localStream) {
        this.localStream.getTracks().forEach(track => {
          this.peerConnection.addTrack(track, this.localStream);
        });
      }
      
      // ICE aday olayını dinle
      this.peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          this.socket.emit('ice-candidate', {
            roomId: this.currentRoomId,
            candidate: event.candidate
          });
        }
      };
      
      // Bağlantı durumu değişikliğini dinle
      this.peerConnection.onconnectionstatechange = (event) => {
        console.log('Bağlantı durumu değişti:', this.peerConnection.connectionState);
        
        if (this.peerConnection.connectionState === 'disconnected' || 
            this.peerConnection.connectionState === 'failed' || 
            this.peerConnection.connectionState === 'closed') {
          console.log('WebRTC bağlantısı koptu');
          
          // Bağlantı koptuğunda UI'ı güncelle
          if (this.inCall) {
            this.showToast('Bağlantı koptu, yeniden bağlanmaya çalışılıyor...', 'warning');
            
            // Kısa bir süre sonra yeniden bağlanmayı dene
            setTimeout(() => {
              if (this.inCall && !this.peerConnection) {
                this.setupPeerConnection(iceServers);
              }
            }, 2000);
          }
        }
      };
      
      // Uzak akış olayını dinle
      this.peerConnection.ontrack = (event) => {
        console.log('Uzak akış alındı:', event.streams[0]);
        this.remoteStream = event.streams[0];
        
        // Uzak video elementini ayarla
        const remoteVideo = document.getElementById('remoteVideo');
        if (remoteVideo) {
          remoteVideo.srcObject = this.remoteStream;
        }
        
        // Karşı tarafın video durumunu varsayılan olarak açık ayarla
        this.peerVideoOff = false;
        
        // Video durumunu karşı tarafa bildir
        if (this.socket && this.currentRoomId) {
          this.socket.emit('video-status', {
            roomId: this.currentRoomId,
            isVideoOff: this.isVideoOff
          });
        }
      };
      
      console.log('WebRTC bağlantısı kuruldu');
      return this.peerConnection;
    } catch (err) {
      console.error('WebRTC bağlantısı kurma hatası:', err);
      this.showToast('Video bağlantısı kurulurken bir hata oluştu', 'error');
      throw err;
    }
  },
  // Önceki bağlantıları temizle
  cleanupPreviousConnections() {
    try {
      // WebRTC bağlantısını kapat
      if (this.peerConnection) {
        this.peerConnection.close();
        this.peerConnection = null;
      }
      
      // Yerel video akışını durdur
      if (this.localStream) {
        this.localStream.getTracks().forEach(track => {
          track.stop();
        });
        this.localStream = null;
      }
      
      // Uzak video akışını temizle
      if (this.remoteStream) {
        this.remoteStream.getTracks().forEach(track => {
          track.stop();
        });
        this.remoteStream = null;
      }
      
      // Uzak video elementini temizle
      const remoteVideo = document.getElementById('remoteVideo');
      if (remoteVideo) {
        remoteVideo.srcObject = null;
      }
      
      // Yerel video elementini temizle
      const localVideo = document.getElementById('localVideo');
      if (localVideo) {
        localVideo.srcObject = null;
      }
      
      // Önizleme video elementini temizle
      const previewVideo = document.getElementById('previewVideo');
      if (previewVideo) {
        previewVideo.srcObject = null;
      }
      
      // Eşleşme kontrolünü temizle
      if (this.matchCheckInterval) {
        clearInterval(this.matchCheckInterval);
        this.matchCheckInterval = null;
      }
      
      // Oda ve eşleşme bilgilerini temizle
      this.currentRoomId = null;
      this.currentPeerId = null;
      
      // Peer video durumunu sıfırla
      this.peerVideoOff = true;
      
      console.log('Önceki bağlantılar temizlendi');
    } catch (err) {
      console.error('Bağlantı temizleme hatası:', err);
    }
  },
  // Görüşmeyi sonlandır ve yeni eşleşme bul
  async endCall() {
    try {
      if (!this.inCall) return;
      
      // Sunucuya bildir
      if (this.currentRoomId) {
        await fetch('/api/end-call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: this.user.id,
            roomId: this.currentRoomId,
            autoRequeue: true // Otomatik olarak yeniden sıraya gir
          })
        });
      }
      
      // Bağlantıları temizle
      this.cleanupPreviousConnections();
      
      // UI'ı sıfırla
      this.inCall = false;
      this.searching = false;
      this.peerVideoOff = true;
      
      // Otomatik olarak eşleşme sırasına gir
      this.waitingAnimation = true;
      this.showToast('Yeni eşleşme için sıraya alındınız', 'info');
      
      // Kısa bir gecikme ekle
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Eşleşme ara
      this.startSearch();
    } catch (err) {
      console.error('Görüşme sonlandırma hatası:', err);
      this.showToast('Görüşme sonlandırılırken bir hata oluştu', 'error');
    }
  },
  // Görüşmeyi sonlandır ve anasayfaya dön
  async endCallWithoutRequeue() {
    try {
      if (!this.inCall) return;
      
      // Sunucuya bildir
      if (this.currentRoomId) {
        await fetch('/api/end-call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: this.user.id,
            roomId: this.currentRoomId,
            autoRequeue: false // Otomatik olarak yeniden sıraya girme
          })
        });
      }
      
      // Bağlantıları temizle
      this.cleanupPreviousConnections();
      
      // UI'ı sıfırla
      this.inCall = false;
      this.searching = false;
      this.waitingAnimation = false;
      this.peerVideoOff = true;
      
      this.showToast('Görüşme sonlandırıldı', 'info');
    } catch (err) {
      console.error('Görüşme sonlandırma hatası:', err);
      this.showToast('Görüşme sonlandırılırken bir hata oluştu', 'error');
    }
  },
  // Mikrofonu aç/kapat
  toggleMic() {
    try {
      if (!this.localStream) return;
      
      this.isMuted = !this.isMuted;
      
      // Ses parçalarını aç/kapat
      this.localStream.getAudioTracks().forEach(track => {
        track.enabled = !this.isMuted;
      });
      
      // Karşı tarafa bildir
      if (this.socket && this.currentRoomId) {
        this.socket.emit('audio-status', {
          roomId: this.currentRoomId,
          isMuted: this.isMuted
        });
      }
      
      this.showToast(this.isMuted ? 'Mikrofon kapatıldı' : 'Mikrofon açıldı', 'info');
    } catch (err) {
      console.error('Mikrofon değiştirme hatası:', err);
      this.showToast('Mikrofon durumu değiştirilirken bir hata oluştu', 'error');
    }
  },
  // Kamerayı aç/kapat
  toggleVideo() {
    try {
      if (!this.localStream) return;
      
      this.isVideoOff = !this.isVideoOff;
      
      // Video parçalarını aç/kapat
      this.localStream.getVideoTracks().forEach(track => {
        track.enabled = !this.isVideoOff;
      });
      
      // Karşı tarafa bildir
      if (this.socket && this.currentRoomId) {
        this.socket.emit('video-status', {
          roomId: this.currentRoomId,
          isVideoOff: this.isVideoOff
        });
      }
      
      this.showToast(this.isVideoOff ? 'Kamera kapatıldı' : 'Kamera açıldı', 'info');
    } catch (err) {
      console.error('Kamera değiştirme hatası:', err);
      this.showToast('Kamera durumu değiştirilirken bir hata oluştu', 'error');
    }
  },
  // Socket.io bağlantısını kur
  async setupSocketConnection() {
    try {
      // Kullanıcı bilgilerinin hazır olmasını bekle
      if (!this.user) {
        if (window.UserData) {
          // Global UserData değişkeninden kullanıcı bilgilerini al
          this.user = window.UserData;
        } else {
          console.log('Kullanıcı bilgileri hazır değil, socket bağlantısı kurulamadı');
          return;
        }
      }

      // Socket.io bağlantısını kur
      this.socket = io();
      console.log('Socket.io bağlantısı kuruldu');
      
      // Kullanıcı bilgilerini gönder
      if (this.user && this.user.id) {
        this.socket.emit('set-user', { 
          userId: this.user.id,
          email: this.user.email || 'misafir@example.com'
        });
      } else {
        console.warn('Kullanıcı bilgileri eksik, kullanıcı tanımlanamadı');
      }
      
      // Socket.io event dinleyicileri
      this.socket.on('match-found', data => {
        // Eşleşme olayı ve diğer kodlar...
      });
    } catch (err) {
      console.error('Socket.io bağlantı hatası:', err);
    }
  },
  // Cleanup before unload
  cleanupBeforeUnload() {
    try {
      // WebRTC bağlantısını kapat
      if (this.peerConnection) {
        this.peerConnection.close();
        this.peerConnection = null;
      }
      
      // Yerel video akışını durdur
      if (this.localStream) {
        this.localStream.getTracks().forEach(track => {
          track.stop();
        });
        this.localStream = null;
      }
      
      // Uzak video akışını temizle
      if (this.remoteStream) {
        this.remoteStream.getTracks().forEach(track => {
          track.stop();
        });
        this.remoteStream = null;
      }
      
      // Eşleşme kontrolünü temizle
      if (this.matchCheckInterval) {
        clearInterval(this.matchCheckInterval);
        this.matchCheckInterval = null;
      }
      
      // Oda ve eşleşme bilgilerini temizle
      this.currentRoomId = null;
      this.currentPeerId = null;
      
      // Peer video durumunu sıfırla
      this.peerVideoOff = true;
      
      console.log('Önceki bağlantılar temizlendi');
    } catch (err) {
      console.error('Bağlantı temizleme hatası:', err);
    }
  },
  // Tema değiştirme
  toggleTheme() {
    this.darkMode = !this.darkMode;
    localStorage.setItem('darkMode', this.darkMode.toString());
  }
}" :class="darkMode ? 'dark' : ''">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-900 shadow-md py-4">
    <div class="container mx-auto flex justify-between items-center px-4">
      <div class="logo flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Opia
      </div>
      <div class="flex items-center">
        <!-- Tema değiştirme butonu -->
        <button @click="toggleTheme()" class="p-2 rounded-full hover:bg-indigo-700">
          <svg x-show="!darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
          <svg x-show="darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </button>
        
        <!-- Kullanıcı giriş yapmadıysa Google ile giriş butonu göster -->
        <button 
          x-show="!user"
          @click="login()" 
          class="flex items-center space-x-2 bg-white text-gray-800 px-4 py-2 ml-4 rounded-lg hover:bg-gray-100"
        >
          <svg width="20" height="20" viewBox="0 0 24 24">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          <span>Google ile Giriş Yap</span>
        </button>
        
        <!-- Kullanıcı giriş yapmışsa e-posta adresi ve avatar göster -->
        <div 
          x-show="user" 
          class="flex items-center space-x-2 bg-indigo-600 bg-opacity-50 text-white px-4 py-2 ml-4 rounded-lg"
        >
          <template x-if="user?.avatar">
            <img :src="user.avatar" class="w-8 h-8 rounded-full border-2 border-white">
          </template>
          <template x-if="!user?.avatar">
            <div class="w-8 h-8 rounded-full bg-indigo-800 flex items-center justify-center text-white font-bold">
              <span x-text="user?.email?.charAt(0).toUpperCase()"></span>
            </div>
          </template>
          <span x-text="user?.email"></span>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- Ana Sayfa -->
    <div x-show="!inCall" class="h-full flex flex-col items-center justify-center">
      <div class="text-center mb-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-2">Opia Görüntülü ve Sesli Sohbet</h2>
        <p class="text-gray-600 dark:text-gray-400">Rastgele kişilerle görüntülü sohbet edin</p>
      </div>
      
      <!-- Bekleme Animasyonu -->
      <div x-show="waitingAnimation" class="mb-8">
        <div class="flex items-center justify-center">
          <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
        </div>
        <p class="mt-4 text-indigo-600 dark:text-indigo-400 font-medium">Eşleşme bekleniyor...</p>
      </div>
      
      <!-- Giriş sonrası kullanıcı bilgisi gösterimi -->
      <div x-show="user" class="flex items-center space-x-2 mb-4">
        <template x-if="user?.avatar">
          <img :src="user.avatar" class="w-8 h-8 rounded-full">
        </template>
        <span class="text-gray-700 dark:text-gray-300" x-text="user?.email || 'Misafir Kullanıcı'"></span>
      </div>
      
      <!-- Kamera ve Mikrofon Kontrolleri -->
      <div class="flex space-x-4 mb-6">
        <button 
          @click="toggleCameraPreview()" 
          class="flex items-center justify-center px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
        >
          <svg x-show="!localStream || isVideoOff" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          <svg x-show="localStream && !isVideoOff" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
          </svg>
          <span x-text="localStream && !isVideoOff ? 'Kamerayı Kapat' : 'Kamerayı Aç'"></span>
        </button>
        
        <button 
          @click="toggleMicPreview()" 
          class="flex items-center justify-center px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
        >
          <svg x-show="!localStream || isMuted" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
          <svg x-show="localStream && !isMuted" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
          </svg>
          <span x-text="localStream && !isMuted ? 'Mikrofonu Kapat' : 'Mikrofonu Aç'"></span>
        </button>
      </div>
      
      <!-- Kamera Önizleme -->
      <div x-show="localStream && !isVideoOff && !inCall" class="mb-6 relative w-64 h-48 rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-700">
        <video 
          id="previewVideo" 
          class="w-full h-full object-cover video-mirror"
          autoplay
          playsinline
          muted
        ></video>
      </div>
      
      <div class="space-y-4">
        <button
          x-show="!searching" 
          @click="toggleSearch()" 
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105"
        >
          Arama Başlat
        </button>
        
        <button
          x-show="searching" 
          @click="cancelSearch()" 
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105"
        >
          Aramayı İptal Et
        </button>
      </div>
    </div>

    <!-- Görüşme Ekranı -->
    <div x-show="inCall" class="h-full flex flex-col">
      <!-- Kontroller -->
      <div class="flex justify-center space-x-4 mb-4">
        <button 
          @click="toggleMic()" 
          class="btn-secondary p-3 rounded-full"
        >
          <svg x-show="!isMuted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
          <svg x-show="isMuted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
          </svg>
        </button>
        
        <button @click="toggleVideo()" class="btn-secondary p-3 rounded-full">
          <span x-show="!isVideoOff">Kamerayı Kapat</span>
          <span x-show="isVideoOff">Kamerayı Aç</span>
        </button>
        
        <button 
          @click="endCallWithoutRequeue()" 
          x-show="inCall"
          class="bg-red-500 text-white p-3 rounded-full hover:bg-red-600"
        >
          Görüşmeyi Sonlandır
        </button>
        
        <button 
          @click="endCall()" 
          x-show="inCall"
          class="bg-indigo-500 text-white p-3 rounded-full hover:bg-indigo-600"
        >
          Yeni Eşleşme Bul
        </button>
      </div>

      <!-- Video ve Sohbet Grid -->
      <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[500px]">
        <!-- Yerel Video -->
        <div class="relative bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden">
          <video 
            id="localVideo" 
            class="w-full h-full object-cover video-mirror"
            autoplay
            playsinline
            muted
          ></video>
          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-center py-1">
            Siz
          </div>
        </div>
        
        <!-- Uzak Video -->
        <div class="relative bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden">
          <video 
            id="remoteVideo" 
            class="w-full h-full object-cover"
            autoplay
            playsinline
          ></video>
          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-center py-1">
            Karşı Taraf
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Footer -->
  <footer class="bg-gray-100 dark:bg-gray-800 py-4 text-center text-gray-600 dark:text-gray-400 text-sm">
    <div class="container mx-auto">
      <p>&copy; 2025 Opia. Tüm hakları saklıdır.</p>
    </div>
  </footer>
  
  <!-- Toast Notifications -->
  <div class="fixed top-4 right-4 z-50 flex flex-col space-y-2">
    <template x-for="toast in toasts" :key="toast.id">
      <div 
        :class="{
          'bg-green-500': toast.type === 'success',
          'bg-blue-500': toast.type === 'info',
          'bg-yellow-500': toast.type === 'warning',
          'bg-red-500': toast.type === 'error'
        }"
        class="text-white px-4 py-2 rounded shadow-lg transition-all duration-500 transform translate-x-0"
      >
        <span x-text="toast.message"></span>
      </div>
    </template>
  </div>

  <!-- Sayfa yüklendiğinde kullanıcı kontrolü -->
  <script>
    // Kullanıcı bilgilerini global değişkene ata
    window.UserData = null;
    
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const supabaseClient = supabase.createClient(
          'https://unrfzoyltrqoyumrbhjo.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVucmZ6b3lsdHJxb3l1bXJiaGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5NDg5NDEsImV4cCI6MjA1NjUyNDk0MX0.4p18-Ohwnerg-qUpKr4f4TQWVWKBJtSdTdmDaoTJLDE'
        );
        
        const { data: { user } } = await supabaseClient.auth.getUser();
        if(user) {
          // Global değişkene kullanıcı bilgilerini ata
          window.UserData = {
            id: user.id,
            email: user.email,
            avatar: user.user_metadata?.avatar_url,
            name: user.user_metadata?.full_name
          };
          
          // Alpine verilerini güncellemek için
          setTimeout(() => {
            if (document.querySelector('body').__x && document.querySelector('body').__x.$data) {
              document.querySelector('body').__x.$data.user = window.UserData;
              console.log('Kullanıcı bilgileri atandı:', window.UserData);
            }
          }, 500);
        }
      } catch (error) {
        console.error('Kullanıcı kontrol hatası:', error);
      }
    });
  </script>
</body>
</html>
