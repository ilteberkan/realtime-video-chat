<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Opia - Görüntülü ve Sesli Sohbet</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
  <script>
    // Global bir değişkene io'yu atayalım ki Alpine.js kapsamından da erişebilelim
    window.ioInstance = null;
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof io !== 'undefined') {
        window.ioInstance = io;
        console.log('Socket.io global olarak tanımlandı');
      } else {
        console.error('Socket.io kütüphanesi yüklenemedi');
      }
    });
  </script>
  <!-- Socket.io CDN yerine mock socket kullanacağız -->
  <script>
    // Socket.io mock oluşturma - gerçek bağlantı kurulamadığında kullanılacak
    window.MockSocket = function() {
      console.log('Mock socket kullanılıyor');
      this.callbacks = {};
      
      this.on = function(event, callback) {
        if (!this.callbacks[event]) {
          this.callbacks[event] = [];
        }
        this.callbacks[event].push(callback);
        return this;
      };
      
      this.emit = function(event, data) {
        console.log(`Mock socket emit: ${event}`, data);
        return this;
      };
      
      this.mockTrigger = function(event, data) {
        if (this.callbacks[event]) {
          this.callbacks[event].forEach(callback => {
            callback(data);
          });
        }
      };
      
      return this;
    };
  </script>
  <!-- Favicon -->
  <link rel="icon" href="data:,">
  <style>
    :root {
      --color-bg: #ffffff;
      --color-text: #333333;
      --color-primary: #4f46e5;
      --color-secondary: #818cf8;
      --color-accent: #c7d2fe;
      --color-card: #f3f4f6;
    }
    
    .dark {
      --color-bg: #1f2937;
      --color-text: #f3f4f6;
      --color-primary: #6366f1;
      --color-secondary: #818cf8;
    }
    
    body {
      background-color: var(--color-bg);
      color: var(--color-text);
    }
    
    .logo {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--color-primary);
    }
    
    .logo svg {
      width: 40px;
      height: 40px;
      vertical-align: middle;
      margin-right: 8px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col" 
  x-data="videoChatApp()" 
  :class="darkMode ? 'dark' : ''" 
  x-init="initApp()">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-900 shadow-md py-4">
    <div class="container mx-auto flex justify-between items-center px-4">
      <div class="logo flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Opia
      </div>
      <div class="flex items-center">
        <!-- Tema değiştirme butonu -->
        <button @click="toggleTheme()" class="p-2 rounded-full hover:bg-indigo-700">
          <svg x-show="!darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
          <svg x-show="darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </button>
        
        <!-- Kullanıcı giriş yapmadıysa Google ile giriş butonu göster -->
        <button 
          x-show="!user"
          @click="login()" 
          class="flex items-center space-x-2 bg-white text-gray-800 px-4 py-2 ml-4 rounded-lg hover:bg-gray-100"
        >
          <svg width="20" height="20" viewBox="0 0 24 24">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          <span>Google ile Giriş Yap</span>
        </button>
        
        <!-- Kullanıcı giriş yapmışsa e-posta adresi ve avatar göster -->
        <div 
          x-show="user" 
          class="flex items-center space-x-2 bg-indigo-600 bg-opacity-50 text-white px-4 py-2 ml-4 rounded-lg"
        >
          <template x-if="user?.avatar">
            <img :src="user.avatar" class="w-8 h-8 rounded-full border-2 border-white">
          </template>
          <template x-if="!user?.avatar">
            <div class="w-8 h-8 rounded-full bg-indigo-800 flex items-center justify-center text-white font-bold">
              <span x-text="user?.email?.charAt(0).toUpperCase()"></span>
            </div>
          </template>
          <span x-text="user?.email"></span>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 py-8">
    <!-- Ana Sayfa -->
    <div x-show="!inCall" class="h-full flex flex-col items-center justify-center">
      <div class="text-center mb-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-2">Opia Görüntülü ve Sesli Sohbet</h2>
        <p class="text-gray-600 dark:text-gray-400">Rastgele kişilerle görüntülü sohbet edin</p>
      </div>
      
      <!-- Bekleme Animasyonu -->
      <div x-show="waitingAnimation" class="mb-8">
        <div class="flex items-center justify-center">
          <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
        </div>
        <p class="mt-4 text-indigo-600 dark:text-indigo-400 font-medium">Eşleşme bekleniyor...</p>
      </div>
      
      <!-- Giriş sonrası kullanıcı bilgisi gösterimi -->
      <div x-show="user" class="flex items-center space-x-2 mb-4">
        <template x-if="user?.avatar">
          <img :src="user.avatar" class="w-8 h-8 rounded-full">
        </template>
        <span class="text-gray-700 dark:text-gray-300" x-text="user?.email || 'Misafir Kullanıcı'"></span>
      </div>
      
      <!-- Kamera ve Mikrofon Kontrolleri -->
      <div class="flex space-x-4 mb-6">
        <button 
          @click="toggleCameraPreview()" 
          class="flex items-center justify-center px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
        >
          <svg x-show="!localStream || isVideoOff" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          <svg x-show="localStream && !isVideoOff" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
          </svg>
          <span x-text="localStream && !isVideoOff ? 'Kamerayı Kapat' : 'Kamerayı Aç'"></span>
        </button>
        
        <button 
          @click="toggleMicPreview()" 
          class="flex items-center justify-center px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
        >
          <svg x-show="!localStream || isMuted" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
          <svg x-show="localStream && !isMuted" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
          </svg>
          <span x-text="localStream && !isMuted ? 'Mikrofonu Kapat' : 'Mikrofonu Aç'"></span>
        </button>
      </div>
      
      <!-- Kamera Önizleme -->
      <div x-show="localStream && !isVideoOff && !inCall" class="mb-6 relative w-64 h-48 rounded-lg overflow-hidden bg-gray-200 dark:bg-gray-700">
        <video 
          id="previewVideo" 
          class="w-full h-full object-cover video-mirror"
          autoplay
          playsinline
          muted
        ></video>
      </div>
      
      <div class="space-y-4">
        <button
          x-show="!searching" 
          @click="toggleSearch()" 
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105"
        >
          Arama Başlat
        </button>
        
        <button
          x-show="searching" 
          @click="cancelSearch()" 
          class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-105"
        >
          Aramayı İptal Et
        </button>
      </div>
    </div>

    <!-- Görüşme Ekranı -->
    <div x-show="inCall" class="h-full flex flex-col">
      <!-- Kontroller -->
      <div class="flex justify-center space-x-4 mb-4">
        <button 
          @click="toggleMic()" 
          class="btn-secondary p-3 rounded-full"
        >
          <svg x-show="!isMuted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
          <svg x-show="isMuted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
          </svg>
        </button>
        
        <button @click="toggleVideo()" class="btn-secondary p-3 rounded-full">
          <span x-show="!isVideoOff">Kamerayı Kapat</span>
          <span x-show="isVideoOff">Kamerayı Aç</span>
        </button>
        
        <button 
          @click="endCallWithoutRequeue()" 
          x-show="inCall"
          class="bg-red-500 text-white p-3 rounded-full hover:bg-red-600"
        >
          Görüşmeyi Sonlandır
        </button>
        
        <button 
          @click="endCall()" 
          x-show="inCall"
          class="bg-indigo-500 text-white p-3 rounded-full hover:bg-indigo-600"
        >
          Yeni Eşleşme Bul
        </button>
      </div>

      <!-- Video ve Sohbet Grid -->
      <div class="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-4 max-h-[calc(100vh-200px)]">
        <!-- Yerel Video -->
        <div class="relative bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden lg:col-span-1">
          <video 
            id="localVideo" 
            class="w-full h-full object-cover video-mirror"
            autoplay
            playsinline
            muted
          ></video>
          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-center py-1">
            Siz <span x-text="user?.name || 'Misafir'"></span>
          </div>
        </div>
        
        <!-- Uzak Video -->
        <div class="relative bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden lg:col-span-1">
          <video 
            id="remoteVideo" 
            class="w-full h-full object-cover"
            autoplay
            playsinline
          ></video>
          <div 
            x-show="!peerVideoOff" 
            class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-center py-1"
          >
            Karşı Taraf
          </div>
          <div 
            x-show="peerVideoOff || !inCall" 
            class="absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 text-white text-center"
          >
            <div>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
              <p x-show="!inCall">Henüz bir görüşme başlatılmadı</p>
              <p x-show="inCall && peerVideoOff">Karşı taraf kamerasını kapattı</p>
            </div>
          </div>
        
        <!-- Chat Alanı -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg flex flex-col lg:col-span-1 h-[calc(100vh-200px)]">
          <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="font-bold text-lg">Sohbet</h3>
          </div>
          
          <!-- Mesaj Listesi -->
          <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messageList">
            <template x-for="(message, index) in messages" :key="index">
              <div :class="{
                'flex flex-col': true,
                'items-end': message.isMe,
                'items-start': !message.isMe
              }">
                <div :class="{
                  'max-w-xs rounded-lg p-3': true,
                  'bg-indigo-500 text-white': message.isMe,
                  'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white': !message.isMe
                }">
                  <p x-text="message.text"></p>
                </div>
                <span class="text-xs text-gray-500 mt-1" x-text="message.time"></span>
              </div>
            </template>
            
            <!-- Boş durumda gösterilecek -->
            <div x-show="messages.length === 0" class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
              <p>Henüz mesaj yok</p>
            </div>
          </div>
          
          <!-- Mesaj Gönderme Formu -->
          <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <form @submit.prevent="sendMessage()" class="flex">
              <input 
                type="text" 
                x-model="messageText" 
                placeholder="Mesajınızı yazın..." 
                class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-white"
                :disabled="!inCall"
              >
              <button 
                type="submit" 
                class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-r-lg"
                :disabled="!inCall"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                </svg>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Footer -->
  <footer class="bg-gray-100 dark:bg-gray-800 py-4 text-center text-gray-600 dark:text-gray-400 text-sm">
    <div class="container mx-auto">
      <p>&copy; 2025 Opia. Tüm hakları saklıdır.</p>
    </div>
  </footer>
  
  <!-- Toast Notifications -->
  <div class="fixed top-4 right-4 z-50 flex flex-col space-y-2">
    <template x-for="toast in toasts" :key="toast.id">
      <div 
        :class="{
          'bg-green-500': toast.type === 'success',
          'bg-blue-500': toast.type === 'info',
          'bg-yellow-500': toast.type === 'warning',
          'bg-red-500': toast.type === 'error'
        }"
        class="text-white px-4 py-2 rounded shadow-lg transition-all duration-500 transform translate-x-0"
      >
        <span x-text="toast.message"></span>
      </div>
    </template>
  </div>

<script>
function videoChatApp() {
  return {
    // State değişkenleri
    darkMode: localStorage.getItem('darkMode') === 'true',
    user: null,
    inCall: false,
    searching: false,
    isMuted: false,
    isVideoOff: false,
    peerVideoOff: true,
    messages: [],
    messageText: '',
    toasts: [],
    isAdmin: false,
    waitingAnimation: false,
    localStream: null,
    remoteStream: null,
    peerConnection: null,
    socket: null,
    currentRoomId: null,
    currentPeerId: null,
    matchCheckInterval: null,
    toastTimeout: null,
    continuousSearch: false,

    // Başlangıç fonksiyonu
    initApp() {
      this.loadUserData();
      this.setupEventListeners();
      this.checkSocketConnection();
    },

    // Toast bildirim sistemi
    showToast(message, type = 'info') {
      const id = Date.now();
      this.toasts.push({ id, message, type });
      setTimeout(() => {
        this.toasts = this.toasts.filter(toast => toast.id !== id);
      }, 3000);
    },

    // Kullanıcı işlemleri
    async login() {
      try {
        const supabaseClient = this.createSupabaseClient();
        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin }
        });
        if (error) throw error;
      } catch (err) {
        this.showToast('Giriş hatası: ' + err.message, 'error');
      }
    },

    // Mesaj gönderme fonksiyonu
    sendMessage() {
      if (this.messageText.trim() === '') return;
      
      const now = new Date();
      const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      
      // Yeni mesaj ekle
      this.messages.push({
        text: this.messageText,
        time: timeStr,
        isMe: true
      });

      // Mock cevap ekle
      setTimeout(() => {
        const responses = [
          "Merhaba, nasılsın?",
          "Anladım, devam et lütfen.",
          "Bu çok ilginç!",
          "Seninle konuşmak güzel.",
          "Daha fazla bilgi verebilir misin?"
        ];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        
        this.messages.push({
          text: randomResponse,
          time: `${now.getHours().toString().padStart(2, '0')}:${(now.getMinutes()+1).toString().padStart(2, '0')}`,
          isMe: false
        });
        
        this.scrollToBottom();
      }, 1000);

      this.messageText = '';
      this.scrollToBottom();
    },

    // Diğer metodlar aynı şekilde devam eder...
    // Tüm metodlar virgüllerle ayrılmalı ve arrow function kullanılmamalı
  }
}
</script>
</body>
</html>
