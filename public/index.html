<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Görüntülü Sohbet</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/alpinejs@3.10.3/dist/cdn.min.js" defer></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <!-- Favicon -->
  <link rel="icon" href="data:,">
  <style>
    :root {
      --color-bg: #ffffff;
      --color-text: #333333;
      --color-primary: #4f46e5;
      --color-secondary: #818cf8;
      --color-accent: #c7d2fe;
      --color-card: #f3f4f6;
    }
    
    .dark {
      --color-bg: #1f2937;
      --color-text: #f3f4f6;
      --color-primary: #6366f1;
      --color-secondary: #818cf8;
      --color-accent: #4f46e5;
      --color-card: #374151;
    }
    
    body {
      background-color: var(--color-bg);
      color: var(--color-text);
      transition: background-color 0.3s, color 0.3s;
    }
    
    .video-container {
      aspect-ratio: 16/9;
      background-color: var(--color-card);
    }
    
    .btn-primary {
      background-color: var(--color-primary);
      color: white;
    }
    
    .btn-secondary {
      background-color: var(--color-secondary);
      color: white;
    }
  </style>
</head>
<body x-data="app()" :class="darkMode ? 'dark' : ''">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4">
      <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-bold">Görüntülü Sohbet</h1>
        <div class="flex items-center space-x-4">
          <!-- Admin Paneli Linki (Sadece adminler için) -->
          <a x-show="isAdmin" href="/admin.html" class="bg-white text-indigo-600 px-3 py-1 rounded-md text-sm hover:bg-indigo-100">
            Admin Paneli
          </a>
          
          <button @click="toggleTheme()" class="p-2 rounded-full hover:bg-indigo-700">
            <svg x-show="!darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
            <svg x-show="darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
          </button>
          <template x-if="!user">
            <button @click="login()" class="bg-white text-indigo-600 px-4 py-2 rounded-md font-medium hover:bg-indigo-100">
              Google ile Giriş Yap
            </button>
          </template>
          <template x-if="user">
            <div class="flex items-center space-x-2">
              <span x-text="user.email"></span>
              <button @click="logout()" class="bg-indigo-700 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-800">
                Çıkış
              </button>
            </div>
          </template>
        </div>
      </div>
    </header>
    
    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4">
      <!-- Auth Screen -->
      <div x-show="!user" class="flex flex-col items-center justify-center h-full">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md max-w-md w-full">
          <h2 class="text-2xl font-bold mb-6 text-center">Görüntülü Sohbete Hoş Geldiniz</h2>
          <p class="mb-6 text-gray-600 dark:text-gray-300 text-center">
            Rastgele kişilerle görüntülü sohbet etmek için giriş yapın.
          </p>
          <button @click="login()" class="w-full bg-indigo-600 text-white py-3 rounded-md font-medium hover:bg-indigo-700 flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z" fill="currentColor"/>
            </svg>
            Google ile Giriş Yap
          </button>
        </div>
      </div>
      
      <!-- Main App (when logged in) -->
      <div x-show="user" class="h-full">
        <!-- Waiting Screen -->
        <div x-show="!inCall && !searching" class="flex flex-col items-center justify-center h-full">
          <h2 class="text-2xl font-bold mb-6">Yeni bir görüşme başlatın</h2>
          <button @click="findMatch()" class="bg-indigo-600 text-white px-6 py-3 rounded-md font-medium hover:bg-indigo-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Görüşme Ara
          </button>
        </div>
        
        <!-- Searching Screen -->
        <div x-show="searching && !inCall" class="flex flex-col items-center justify-center h-full">
          <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600 mb-4"></div>
          <h2 class="text-xl font-medium mb-2">Eşleşme aranıyor...</h2>
          <p class="text-gray-600 dark:text-gray-300 mb-4">Lütfen bekleyin, size uygun bir eşleşme bulunuyor.</p>
          <button @click="cancelSearch()" class="bg-red-600 text-white px-4 py-2 rounded-md font-medium hover:bg-red-700">
            Aramayı İptal Et
          </button>
        </div>
        
        <!-- Video Call Screen -->
        <div x-show="inCall" class="h-full flex flex-col">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-grow">
            <!-- Videos Container -->
            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Local Video -->
              <div class="relative">
                <div class="video-container rounded-lg overflow-hidden w-full h-full">
                  <video id="localVideo" autoplay muted class="w-full h-full object-cover"></video>
                </div>
                <div class="absolute bottom-4 left-4 text-white bg-black bg-opacity-50 px-2 py-1 rounded">
                  Sen
                </div>
              </div>
              
              <!-- Remote Video -->
              <div class="relative">
                <div class="video-container rounded-lg overflow-hidden w-full h-full">
                  <video id="remoteVideo" autoplay class="w-full h-full object-cover"></video>
                </div>
                <div class="absolute bottom-4 left-4 text-white bg-black bg-opacity-50 px-2 py-1 rounded">
                  Eşleşme
                </div>
              </div>
            </div>
            
            <!-- Chat Container -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md flex flex-col h-full">
              <div class="p-3 bg-indigo-600 text-white rounded-t-lg">
                <h3 class="font-medium">Sohbet</h3>
              </div>
              <div class="flex-grow p-3 overflow-y-auto" id="chatMessages">
                <div class="space-y-3">
                  <template x-for="(message, index) in messages" :key="index">
                    <div :class="message.isMine ? 'ml-auto bg-indigo-100 dark:bg-indigo-900' : 'mr-auto bg-gray-100 dark:bg-gray-700'" 
                         class="max-w-[80%] rounded-lg p-3 mb-2">
                      <div class="font-medium text-xs mb-1" x-text="message.username || (message.isMine ? getUserDisplayName() : 'Eşleşme')" 
                           :class="message.isMine ? 'text-indigo-700 dark:text-indigo-300' : 'text-gray-700 dark:text-gray-300'"></div>
                      <p x-text="message.text" class="text-gray-800 dark:text-gray-200 text-sm"></p>
                      <span class="text-xs text-gray-500 dark:text-gray-400" x-text="message.time"></span>
                    </div>
                  </template>
                </div>
              </div>
              <!-- Mesaj Gönderme Formu -->
              <div class="flex items-center p-4 border-t border-gray-200 dark:border-gray-700">
                <input 
                  type="text" 
                  x-model="messageText" 
                  @keydown.enter="sendMessage()" 
                  placeholder="Mesajınızı yazın..." 
                  class="flex-grow px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white"
                >
                <button 
                  @click="sendMessage()" 
                  class="bg-indigo-600 text-white px-4 py-2 rounded-r-md hover:bg-indigo-700"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Call Controls -->
          <div class="flex justify-center items-center space-x-4 mt-4 p-3 bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <button @click="toggleMute()" class="bg-gray-500 text-white p-3 rounded-full hover:bg-gray-600">
              <svg x-show="!isMuted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              </svg>
              <svg x-show="isMuted" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
              </svg>
            </button>
            <button @click="toggleVideo()" class="bg-gray-500 text-white p-3 rounded-full hover:bg-gray-600">
              <svg x-show="!isVideoOff" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              <svg x-show="isVideoOff" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
              </svg>
            </button>
            <button @click="likeUser()" class="bg-green-500 text-white p-3 rounded-full hover:bg-green-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
              </svg>
            </button>
            <button @click="endCall()" class="bg-red-600 text-white p-4 rounded-full hover:bg-red-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z" />
              </svg>
            </button>
            <button @click="dislike()" class="bg-gray-500 text-white p-3 rounded-full hover:bg-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-gray-800 py-4">
      <div class="container mx-auto text-center text-gray-600 dark:text-gray-300 text-sm">
        &copy; 2023 Görüntülü Sohbet Uygulaması. Tüm hakları saklıdır.
      </div>
    </footer>
  </div>
  
  <!-- Like Animation -->
  <div x-show="showLikeAnimation" x-transition:enter="transition ease-out duration-300" 
       x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100"
       x-transition:leave="transition ease-in duration-300" x-transition:leave-start="opacity-100 scale-100" 
       x-transition:leave-end="opacity-0 scale-90"
       class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-green-500 mx-auto animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
      </svg>
      <h2 class="text-2xl font-bold mt-4">Beğenildi!</h2>
      <p class="mt-2">Karşı taraf sizi beğendi!</p>
    </div>
  </div>

  
  
  <!-- Profile Modal -->
  <div x-show="showProfileModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 transition-opacity" aria-hidden="true">
        <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
      </div>
      
      <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                Profil Düzenle
              </h3>
              
              <div class="mt-4 space-y-4">
                <!-- Profil Resmi -->
                <div class="flex flex-col items-center">
                  <div class="relative w-24 h-24 mb-2">
                    <img :src="profile.avatar_url || 'https://ui-avatars.com/api/?name=User&background=random'" alt="Profil Resmi" class="w-full h-full rounded-full object-cover">
                    <button @click="uploadAvatar()" class="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </button>
                    <input type="file" id="avatarUpload" @change="handleAvatarChange" class="hidden" accept="image/*">
                  </div>
                </div>
                
                <!-- Kullanıcı Adı -->
                <div>
                  <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Kullanıcı Adı
                  </label>
                  <input type="text" id="username" x-model="profile.username" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white">
                </div>
                
                <!-- Hakkımda -->
                <div>
                  <label for="bio" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                    Hakkımda
                  </label>
                  <textarea id="bio" x-model="profile.bio" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white"></textarea>
                </div>
                
                <!-- İlgi Alanları -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                    İlgi Alanları
                  </label>
                  <div class="mt-1 flex flex-wrap gap-2">
                    <template x-for="(interest, index) in profile.interests" :key="index">
                      <div class="bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-2 py-1 rounded-md flex items-center">
                        <span x-text="interest"></span>
                        <button @click="removeInterest(index)" class="ml-1 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-200">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    </template>
                  </div>
                  <div class="mt-2 flex">
                    <input type="text" x-model="newInterest" @keydown.enter.prevent="addInterest()" placeholder="Yeni ilgi alanı ekle" class="flex-grow px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:text-white">
                    <button @click="addInterest()" class="bg-indigo-600 text-white px-3 py-2 rounded-r-md hover:bg-indigo-700">
                      Ekle
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button @click="saveProfile()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
            Kaydet
          </button>
          <button @click="showProfileModal = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            İptal
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase istemcisini oluştur
    const supabaseUrl = 'https://unrfzoyltrqoyumrbhjo.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVucmZ6b3lsdHJxb3l1bXJiaGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5NDg5NDEsImV4cCI6MjA1NjUyNDk0MX0.4p18-Ohwnerg-qUpKr4f4TQWVWKBJtSdTdmDaoTJLDE';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Socket.io bağlantısı
    const socket = io({
      path: '/socket.io',
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
      timeout: 20000,
      transports: ['websocket', 'polling']
    });
    
    // Alpine.js uygulaması
    function app() {
      return {
        user: null,
        darkMode: localStorage.getItem('darkMode') === 'true',
        inCall: false,
        searching: false,
        currentRoomId: null,
        currentPeerId: null,
        localStream: null,
        remoteStream: null,
        peerConnection: null,
        isMuted: false,
        isVideoOff: false,
        messages: [],
        messageText: '',
        profile: {
          username: '',
          bio: '',
          avatar_url: '',
          interests: []
        },
        showProfileModal: false,
        showLikeAnimation: false,
        showDislikeAnimation: false,
        newInterest: '',
        isAdmin: false,
        
        // Sayfa yüklendiğinde
        init() {
          this.checkSession();
          
          // Karanlık mod
          if (this.darkMode) {
            document.documentElement.classList.add('dark');
          }
          
          // Durumları sıfırla
          this.inCall = false;
          this.searching = false;
          this.currentRoomId = null;
          this.currentPeerId = null;
          
          // Socket.io dinleyicilerini kur
          this.setupSocketListeners();
          
          // Sayfa kapatıldığında görüşmeyi sonlandır
          window.addEventListener('beforeunload', () => {
            if (this.inCall) {
              this.endCall();
            }
          });
        },
        
        // Oturum durumunu kontrol et
        async checkSession() {
          try {
            console.log('Oturum kontrolü yapılıyor...');
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (session) {
              this.user = session.user;
              
              // Socket.io kimlik doğrulama
              socket.emit('authenticate', session.access_token);
              
              // Profil bilgilerini al
              this.fetchProfile();
            }
          } catch (err) {
            console.error('Oturum kontrolü hatası:', err);
          }
        },
        
        // Google ile giriş
        async login() {
          try {
            console.log('Google ile giriş başlatılıyor...');
            console.log('Redirect URL:', window.location.origin);
            
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
              provider: 'google',
              options: {
                redirectTo: window.location.origin,
                scopes: 'email profile'
              }
            });
            
            console.log('Giriş yanıtı:', data);
            
            if (error) {
              console.error('Giriş hatası:', error);
              alert('Giriş yapılırken bir hata oluştu: ' + error.message);
            }
          } catch (err) {
            console.error('Giriş hatası (catch):', err);
            alert('Giriş yapılırken bir hata oluştu: ' + err.message);
          }
        },
        
        // Çıkış yap
        async logout() {
          try {
            await supabaseClient.auth.signOut();
            this.user = null;
            
            // Görüşmeyi sonlandır
            if (this.inCall) {
              this.endCall();
            }
          } catch (err) {
            console.error('Çıkış hatası:', err);
          }
        },
        
        // Socket.io olaylarını dinle
        setupSocketListeners() {
          // Kimlik doğrulama başarılı
          socket.on('auth_success', (data) => {
            console.log('Socket.io kimlik doğrulaması başarılı:', data);
            
            // Ses tanıma özelliğini kur (tarayıcı destekliyorsa)
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
              this.setupSpeechRecognition();
            }
          });
          
          // Kimlik doğrulama hatası
          socket.on('auth_error', (data) => {
            console.error('Socket.io kimlik doğrulaması başarısız:', data);
            
            // Kullanıcı banlandıysa bilgi göster
            if (data.banInfo) {
              alert(`Hesabınız banlandı. Neden: ${data.banInfo.reason}. Ban süresi: ${new Date(data.banInfo.expiresAt).toLocaleString()}`);
            }
          });
          
          // Eşleşme bulundu
          socket.on('match_found', (data) => {
            console.log('Eşleşme bulundu:', data);
            this.searching = false;
            this.inCall = true;
            this.currentRoomId = data.roomId;
            this.currentPeerId = data.peerId;
            
            // WebRTC bağlantısını kur
            this.setupWebRTC(data);
          });
          
          // Hata
          socket.on('error', (data) => {
            console.error('Socket.io hatası:', data);
            
            // Eğer "Zaten bir odadasınız" hatası gelirse, durumları düzelt
            if (data.message === 'Zaten bir odadasınız') {
              this.searching = false;
              
              // Eğer inCall false ise ama sunucu bizi bir odada görüyorsa
              if (!this.inCall) {
                // Odadan çık ve durumları sıfırla
                socket.emit('leave_room', { roomId: this.currentRoomId || 'unknown' });
                this.currentRoomId = null;
                this.currentPeerId = null;
                
                // Kullanıcıya bilgi ver
                this.showToast('Önceki oturum temizlendi, tekrar deneyin', 'info');
                
                // 1 saniye sonra tekrar eşleşme aramayı dene
                setTimeout(() => {
                  this.findMatch();
                }, 1000);
              }
            }
          });
          
          // Kullanıcı bağlantısı kesildi
          socket.on('user_disconnected', () => {
            console.log('Karşı taraf bağlantıyı kesti');
            this.showToast('Karşı taraf bağlantıyı kesti', 'error');
            this.endCall();
          });
          
          // Mesaj alındı
          socket.on('receive_message', (data) => {
            console.log('Mesaj alındı:', data);
            
            // Mesajı ekle
            this.messages.push({
              text: data.message,
              isMine: false,
              time: new Date().toLocaleTimeString(),
              username: data.username || 'Eşleşme'
            });
            
            // Mesaj alanına kaydır
            this.$nextTick(() => {
              const chatMessages = document.querySelector('.chat-messages');
              if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
              }
            });
          });
        },
        
        // Eşleşme ara
        async findMatch() {
          // Eğer zaten bir görüşmedeyse, işlemi engelle
          if (this.inCall) {
            console.log('Zaten bir görüşmedesiniz');
            this.showToast('Zaten bir görüşmedesiniz', 'error');
            return;
          }
          
          // Eğer zaten arama yapıyorsa, işlemi engelle
          if (this.searching) {
            console.log('Zaten eşleşme aranıyor');
            this.showToast('Zaten eşleşme aranıyor', 'info');
            return;
          }
          
          // Durumları temizle
          if (this.currentRoomId) {
            socket.emit('leave_room', { roomId: this.currentRoomId });
            this.currentRoomId = null;
            this.currentPeerId = null;
          }
          
          this.searching = true;
          
          try {
            // Eşleşme aramaya başla
            socket.emit('find_match');
            console.log('Eşleşme aranıyor...');
          } catch (err) {
            console.error('Eşleşme arama hatası:', err);
            this.searching = false;
            this.showToast('Eşleşme arama hatası', 'error');
          }
        },
        
        // Aramayı iptal et
        cancelSearch() {
          if (!this.searching) return;
          
          this.searching = false;
          socket.emit('cancel_search');
          console.log('Arama iptal edildi');
          
          // Durumları temizle
          if (this.currentRoomId) {
            socket.emit('leave_room', { roomId: this.currentRoomId });
            this.currentRoomId = null;
            this.currentPeerId = null;
          }
        },
        
        // WebRTC kurulumu
        async setupWebRTC(data) {
          try {
            console.log('WebRTC kurulumu başlatılıyor...', data);
            this.currentRoomId = data.roomId;
            
            // Medya akışını al
            this.localStream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true
            });
            
            // Yerel video elementini ayarla
            const localVideo = document.getElementById('localVideo');
            if (localVideo) {
              localVideo.srcObject = this.localStream;
              localVideo.play().catch(e => console.error('Yerel video oynatma hatası:', e));
            }
            
            // RTCPeerConnection oluştur
            const iceServers = [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' },
              {
                urls: 'turn:openrelay.metered.ca:80',
                username: 'openrelayproject',
                credential: 'openrelayproject'
              }
            ];
            
            console.log('ICE Sunucuları:', iceServers);
            
            this.peerConnection = new RTCPeerConnection({
              iceServers: iceServers
            });
            
            // Yerel medya akışını ekle
            this.localStream.getTracks().forEach(track => {
              console.log('Yerel track ekleniyor:', track.kind);
              this.peerConnection.addTrack(track, this.localStream);
            });
            
            // Uzak medya akışını işle
            this.peerConnection.ontrack = (event) => {
              console.log('Uzak track alındı:', event.track.kind);
              const remoteVideo = document.getElementById('remoteVideo');
              
              if (remoteVideo) {
                if (!remoteVideo.srcObject) {
                  remoteVideo.srcObject = new MediaStream();
                }
                
                // Yeni track'i uzak video akışına ekle
                remoteVideo.srcObject.addTrack(event.track);
                console.log('Uzak video akışı güncellendi');
              }
            };
            
            // ICE adaylarını işle
            this.peerConnection.onicecandidate = (event) => {
              if (event.candidate) {
                console.log('ICE adayı gönderiliyor');
                socket.emit('ice_candidate', {
                  roomId: this.currentRoomId,
                  candidate: event.candidate
                });
              }
            };
            
            // Bağlantı durumunu izle
            this.peerConnection.oniceconnectionstatechange = () => {
              console.log('ICE bağlantı durumu:', this.peerConnection.iceConnectionState);
              
              if (this.peerConnection.iceConnectionState === 'connected' || 
                  this.peerConnection.iceConnectionState === 'completed') {
                console.log('WebRTC bağlantısı kuruldu!');
              } else if (this.peerConnection.iceConnectionState === 'disconnected' ||
                        this.peerConnection.iceConnectionState === 'failed' ||
                        this.peerConnection.iceConnectionState === 'closed') {
                console.log('WebRTC bağlantısı kesildi veya başarısız oldu');
                this.endCallCleanup();
              }
            };
            
            // Teklif oluştur (başlatan taraf)
            if (data.isInitiator) {
              console.log('Teklif oluşturuluyor (başlatan)');
              const offer = await this.peerConnection.createOffer();
              await this.peerConnection.setLocalDescription(offer);
              
              console.log('SDP teklifi gönderiliyor');
              socket.emit('offer', {
                roomId: this.currentRoomId,
                offer: offer
              });
            }
            
          } catch (error) {
            console.error('WebRTC kurulum hatası:', error);
            alert('Kamera veya mikrofon erişimi sağlanamadı. Lütfen izinleri kontrol edin.');
            this.endCallCleanup();
          }
        },
        
        // Teklifi işle
        async handleOffer(data) {
          try {
            console.log('Teklif alındı:', data);
            
            if (!this.peerConnection) {
              await this.setupWebRTC({ roomId: data.roomId, isInitiator: false });
            }
            
            await this.peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            
            console.log('Yanıt oluşturuluyor');
            const answer = await this.peerConnection.createAnswer();
            await this.peerConnection.setLocalDescription(answer);
            
            console.log('SDP yanıtı gönderiliyor');
            socket.emit('answer', {
              roomId: this.currentRoomId,
              answer: answer
            });
          } catch (error) {
            console.error('Teklif işleme hatası:', error);
          }
        },
        
        // Yanıtı işle
        async handleAnswer(data) {
          try {
            console.log('Yanıt alındı:', data);
            await this.peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
          } catch (error) {
            console.error('Yanıt işleme hatası:', error);
          }
        },
        
        // ICE adayını işle
        async handleIceCandidate(data) {
          try {
            console.log('ICE adayı alındı:', data);
            if (this.peerConnection) {
              await this.peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
          } catch (error) {
            console.error('ICE adayı işleme hatası:', error);
          }
        },
        
        // Kullanıcıyı beğen
        likeUser() {
          if (!this.currentRoomId) return;
          
          socket.emit('like', this.currentRoomId);
          alert('Kullanıcıyı beğendiniz!');
        },
        
        // Kullanıcıyı beğenme
        async dislike() {
          if (!this.currentRoomId) return;
          
          // Beğenmeme durumunu kaydet
          try {
            const { data, error } = await fetch('/api/dislike', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session.access_token}`
              },
              body: JSON.stringify({
                roomId: this.currentRoomId
              })
            }).then(res => res.json());
            
            if (error) {
              console.error('Beğenmeme hatası:', error);
            } else {
              // Beğenmeme durumunu göster
              this.showToast('Kullanıcıyı beğenmediniz');
              
              // Beğenmeme sayacını artır
              this.dislikeCount++;
              
              // NOT: Görüşmeyi kapatmıyoruz, sadece beğenmeme durumunu kaydediyoruz
            }
          } catch (err) {
            console.error('Beğenmeme hatası:', err);
          }
        },
        
        // Görüşmeyi sonlandır
        async endCall() {
          if (!this.currentRoomId) return;
          
          try {
            // Görüşmeyi sonlandır
            socket.emit('leave_room', { roomId: this.currentRoomId });
            
            // Medya akışlarını kapat
            if (this.localStream) {
              this.localStream.getTracks().forEach(track => track.stop());
              this.localStream = null;
            }
            
            // Peer bağlantısını kapat
            if (this.peerConnection) {
              this.peerConnection.close();
              this.peerConnection = null;
            }
            
            // Durumları sıfırla
            this.currentRoomId = null;
            this.currentPeerId = null;
            this.inCall = false;
            this.searching = false;
            this.isMuted = false;
            this.isVideoOff = false;
            this.messages = [];
            
            // Video elementlerini temizle
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            if (localVideo) localVideo.srcObject = null;
            if (remoteVideo) remoteVideo.srcObject = null;
            
            console.log('Görüşme sonlandırıldı');
          } catch (err) {
            console.error('Görüşme sonlandırma hatası:', err);
          }
        },
        
        // Ses tanıma kurulumu
        setupSpeechRecognition() {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) {
            console.log('Tarayıcınız ses tanıma özelliğini desteklemiyor');
            return;
          }
          
          this.recognition = new SpeechRecognition();
          this.recognition.continuous = true;
          this.recognition.interimResults = true;
          this.recognition.lang = 'tr-TR';
          
          this.recognition.onresult = (event) => {
            const last = event.results.length - 1;
            const transcript = event.results[last][0].transcript.trim();
            
            if (transcript && event.results[last].isFinal) {
              console.log('Ses tanıma sonucu:', transcript);
              this.messageText = transcript;
              this.sendMessage();
            }
          };
          
          this.recognition.onerror = (event) => {
            // no-speech hatasını gösterme, diğer hataları göster
            if (event.error !== 'no-speech') {
              console.error('Ses tanıma hatası:', event.error);
            }
          };
          
          this.recognition.onend = () => {
            // Ses tanıma durduğunda tekrar başlat (eğer görüşmedeyse)
            if (this.inCall && !this.isMuted) {
              try {
                this.recognition.start();
              } catch (e) {
                // Zaten çalışıyorsa hata vermesini engelle
                console.log('Ses tanıma zaten çalışıyor veya başlatılamadı');
              }
            }
          };
        },
        
        // Mesaj gönderme
        async sendMessage() {
          if (!this.currentRoomId || !this.messageText.trim()) return;
          
          try {
            // Mesajı gönder
            socket.emit('send_message', {
              roomId: this.currentRoomId,
              message: this.messageText.trim()
            });
            
            // Mesajı kendi listene ekle
            this.messages.push({
              text: this.messageText.trim(),
              isMine: true,
              time: new Date().toLocaleTimeString()
            });
            
            // Mesaj alanını temizle
            this.messageText = '';
            
            // Mesaj alanına kaydır
            this.$nextTick(() => {
              const chatMessages = document.querySelector('.chat-messages');
              if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
              }
            });
          } catch (err) {
            console.error('Mesaj gönderme hatası:', err);
          }
        },
        
        // Kullanıcı görünen adını belirle
        getUserDisplayName() {
          if (this.profile && this.profile.username) {
            return this.profile.username;
          } else if (this.user && this.user.email) {
            // E-posta adresinden kullanıcı adı çıkar (@'den önceki kısım)
            return this.user.email.split('@')[0];
          } else {
            return 'Kullanıcı';
          }
        },
        
        // Ses durumu değiştirme
        toggleMute() {
          if (this.localStream) {
            const audioTracks = this.localStream.getAudioTracks();
            audioTracks.forEach(track => {
              track.enabled = !track.enabled;
              this.isMuted = !track.enabled;
            });
            console.log('Ses durumu:', this.isMuted ? 'Kapalı' : 'Açık');
          }
        },
        
        // Video durumu değiştirme
        toggleVideo() {
          if (this.localStream) {
            const videoTracks = this.localStream.getVideoTracks();
            videoTracks.forEach(track => {
              track.enabled = !track.enabled;
              this.isVideoOff = !track.enabled;
            });
            console.log('Video durumu:', this.isVideoOff ? 'Kapalı' : 'Açık');
          }
        },
        
        // Avatar yükleme
        uploadAvatar() {
          document.getElementById('avatarUpload').click();
        },
        
        // Avatar değiştirme
        handleAvatarChange(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              this.profile.avatar_url = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        },
        
        // İlgi alanı ekleme
        addInterest() {
          if (this.newInterest.trim()) {
            if (!this.profile.interests) {
              this.profile.interests = [];
            }
            this.profile.interests.push(this.newInterest.trim());
            this.newInterest = '';
          }
        },
        
        // İlgi alanı kaldırma
        removeInterest(index) {
          this.profile.interests.splice(index, 1);
        },
        
        // Profil kaydetme
        async saveProfile() {
          try {
            const { data, error } = await supabaseClient.auth.updateUser({
              data: {
                username: this.profile.username,
                bio: this.profile.bio,
                avatar_url: this.profile.avatar_url,
                interests: this.profile.interests
              }
            });
            
            if (error) {
              console.error('Profil güncelleme hatası:', error);
              this.showToast('Profil güncellenirken bir hata oluştu', 'error');
            } else {
              console.log('Profil güncellendi:', data);
              this.showToast('Profiliniz başarıyla güncellendi', 'success');
              this.showProfileModal = false;
            }
          } catch (err) {
            console.error('Profil güncelleme hatası:', err);
            this.showToast('Profil güncellenirken bir hata oluştu', 'error');
          }
        },
        
        // Profil bilgilerini al
        async fetchProfile() {
          try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            
            if (user) {
              this.profile = {
                username: user.user_metadata?.username || '',
                bio: user.user_metadata?.bio || '',
                avatar_url: user.user_metadata?.avatar_url || '',
                interests: user.user_metadata?.interests || []
              };
            }
          } catch (err) {
            console.error('Profil bilgileri alınamadı:', err);
          }
        },
        
        // Admin kontrolü
        async checkAdmin() {
          try {
            console.log('Admin yetkisi kontrolü yapılıyor...');
            
            // Oturum kontrolü
            const session = await supabaseClient.auth.getSession();
            
            if (!session || !session.data || !session.data.session) {
              console.error('Oturum bulunamadı');
              this.isAdmin = false;
              return false;
            }
            
            const token = session.data.session.access_token;
            
            // Admin kontrolü API'si
            const response = await fetch('/api/admin/check', {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            
            if (response.ok) {
              const result = await response.json();
              
              if (result.data && result.data.isAdmin) {
                // Admin ise admin sayfasına yönlendir
                window.location.href = '/admin.html';
              }
            }
          } catch (err) {
            console.error('Admin kontrolü hatası:', err);
            this.isAdmin = false;
          }
        },
        
        // Profil modalını aç
        openProfileModal() {
          this.showProfileModal = true;
        },
        
        // Profil modalını kapat
        closeProfileModal() {
          this.showProfileModal = false;
        },
        
        // Profil düzenleme işlemleri
        showToast(message, type = 'success') {
          // Toast mesajı için HTML elementi oluştur
          const toast = document.createElement('div');
          
          // Safari ve diğer tarayıcılar için uyumlu stil
          toast.style.position = 'fixed';
          toast.style.bottom = '1rem';
          toast.style.right = '1rem';
          toast.style.padding = '0.5rem 1rem';
          toast.style.borderRadius = '0.375rem';
          toast.style.color = 'white';
          toast.style.zIndex = '50';
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 300ms';
          
          // Tip bazında arka plan rengi
          if (type === 'success') {
            toast.style.backgroundColor = '#10B981'; // green-500
          } else if (type === 'error') {
            toast.style.backgroundColor = '#EF4444'; // red-500
          } else if (type === 'info') {
            toast.style.backgroundColor = '#3B82F6'; // blue-500
          } else {
            toast.style.backgroundColor = '#6B7280'; // gray-500
          }
          
          toast.textContent = message;
          
          // Toast'u sayfaya ekle
          document.body.appendChild(toast);
          
          // Animasyon için setTimeout kullan
          setTimeout(() => {
            toast.style.opacity = '1';
          }, 10);
          
          // 3 saniye sonra toast'u kaldır
          setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
              if (document.body.contains(toast)) {
                document.body.removeChild(toast);
              }
            }, 300);
          }, 3000);
          
          // Konsola da yazdır
          console.log(`${type.toUpperCase()}: ${message}`);
        }
      };
    }
  </script>
</body>
</html>
